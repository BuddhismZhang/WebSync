<!DOCTYPE html>

<html>
<head>
  <title>main.rb</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="core.html">
                core.js
              </a>
            
              
              <a class="source" href="edit.html">
                edit.js
              </a>
            
              
              <a class="source" href="chat.html">
                chat.js
              </a>
            
              
              <a class="source" href="drawing.html">
                drawing.js
              </a>
            
              
              <a class="source" href="equations.html">
                equations.js
              </a>
            
              
              <a class="source" href="note.html">
                note.js
              </a>
            
              
              <a class="source" href="page.html">
                page.js
              </a>
            
              
              <a class="source" href="presentation.html">
                presentation.js
              </a>
            
              
              <a class="source" href="resize.html">
                resize.js
              </a>
            
              
              <a class="source" href="spreadsheet.html">
                spreadsheet.js
              </a>
            
              
              <a class="source" href="tables.html">
                tables.js
              </a>
            
              
              <a class="source" href="backend.html">
                backend.js
              </a>
            
              
              <a class="source" href="main.html">
                main.rb
              </a>
            
              
              <a class="source" href="models.html">
                models.rb
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>main.rb</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>It was the night before Christmas and all through the house, not a creature was coding: UTF-8, not even with a mouse.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">require</span> <span class="hljs-string">'bundler'</span>
<span class="hljs-keyword">require</span> <span class="hljs-string">'sass'</span>
<span class="hljs-constant">Bundler</span>.<span class="hljs-keyword">require</span>(<span class="hljs-symbol">:default</span>)
<span class="hljs-keyword">require</span> <span class="hljs-string">'tempfile'</span>
<span class="hljs-keyword">require</span> <span class="hljs-string">'digest/md5'</span>
<span class="hljs-variable">$config</span> = <span class="hljs-constant">MultiJson</span>.load(<span class="hljs-constant">File</span>.open(<span class="hljs-string">'./config.json'</span>).read)</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Monkey patched Redis for easy caching.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Redis</span></span>
  <span class="hljs-function"><span class="hljs-keyword">def</span> </span>cache(key, expire=<span class="hljs-keyword">nil</span>)
    <span class="hljs-keyword">if</span> (value = get(key)).<span class="hljs-keyword">nil</span>?
      value = <span class="hljs-keyword">yield</span>(<span class="hljs-keyword">self</span>)
      set(key, value)
      expire(key, expire) <span class="hljs-keyword">if</span> expire
      value
    <span class="hljs-keyword">else</span>
      value
    <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>
<span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-constant">ENV</span>.key? <span class="hljs-string">"CONFIGMODE"</span>
    <span class="hljs-keyword">require</span> <span class="hljs-string">'./lib/models'</span>
<span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> </span>json_to_html_node obj
    html = <span class="hljs-string">""</span>;
    <span class="hljs-keyword">if</span> obj[<span class="hljs-string">'name'</span>]==<span class="hljs-string">"#text"</span>
        <span class="hljs-keyword">return</span> obj[<span class="hljs-string">'textContent'</span>]
    <span class="hljs-keyword">end</span>
    html+=<span class="hljs-string">"&lt;"</span>+obj[<span class="hljs-string">'name'</span>]
    obj.each <span class="hljs-keyword">do</span> |k,v|
        <span class="hljs-keyword">if</span> k!=<span class="hljs-string">"name"</span>&amp;&amp;k!=<span class="hljs-string">"textContent"</span>&amp;&amp;k!=<span class="hljs-string">"childNodes"</span>
            html+=<span class="hljs-string">" "</span>+k+<span class="hljs-string">"="</span>+<span class="hljs-constant">MultiJson</span>.dump(v)
        <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">end</span>

    <span class="hljs-keyword">if</span> obj.has_key? <span class="hljs-string">'childNodes'</span>
        html+=<span class="hljs-string">"&gt;"</span>;
        obj[<span class="hljs-string">'childNodes'</span>].each <span class="hljs-keyword">do</span> |elem|
            html+= json_to_html_node(elem)
        <span class="hljs-keyword">end</span>
        html+=<span class="hljs-string">"&lt;/"</span>+obj[<span class="hljs-string">'name'</span>]+<span class="hljs-string">"&gt;"</span>
    <span class="hljs-keyword">else</span>
        html+=<span class="hljs-string">"/&gt;"</span>
    <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">return</span> html
<span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> </span>json_to_html obj
    html = <span class="hljs-string">""</span>
    obj.each <span class="hljs-keyword">do</span> |elem|
        html += json_to_html_node(elem)
    <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">return</span> html
<span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> </span>node_to_json html
    <span class="hljs-keyword">if</span> html.name==<span class="hljs-string">"text"</span>
        <span class="hljs-keyword">return</span> { <span class="hljs-symbol">name:</span> <span class="hljs-string">"#text"</span>, <span class="hljs-symbol">textContent:</span> html.to_s}
    <span class="hljs-keyword">end</span>
    json = {
        <span class="hljs-symbol">name:</span> html.name.upcase
    }
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">defined</span>? html.attributes
        html.attributes.each <span class="hljs-keyword">do</span> |name, attr|
            json[attr.name]=attr.value
        <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">if</span> html.children.length &gt; <span class="hljs-number">0</span>
        json[<span class="hljs-string">'childNodes'</span>]=[]
        html.children.each <span class="hljs-keyword">do</span> |child|
            json[<span class="hljs-string">'childNodes'</span>].push( node_to_json(child) )
        <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">return</span> json
<span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> </span>html_to_json html
    dom = <span class="hljs-constant">Nokogiri::HTML</span>(html)
    json = []
    dom.document.children.each <span class="hljs-keyword">do</span> |elem|
        json.push node_to_json(elem)
    <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">return</span> json
<span class="hljs-keyword">end</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WebSync</span> <span class="hljs-inheritance">&lt; <span class="hljs-parent">Sinatra::Base</span></span></span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>register Sinatra::Synchrony</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    use <span class="hljs-constant">Rack::Logger</span>
    helpers <span class="hljs-keyword">do</span>
        <span class="hljs-function"><span class="hljs-keyword">def</span> </span>h(text)
            <span class="hljs-constant">Rack::Utils</span>.escape_html(text)
        <span class="hljs-keyword">end</span>
        <span class="hljs-function"><span class="hljs-keyword">def</span> </span>logger
            request.logger
        <span class="hljs-keyword">end</span>
        <span class="hljs-function"><span class="hljs-keyword">def</span> </span>current_user
            <span class="hljs-keyword">if</span> logged_in?
                <span class="hljs-keyword">return</span> <span class="hljs-constant">User</span>.get(session[<span class="hljs-string">'user'</span>])
            <span class="hljs-keyword">end</span>
            <span class="hljs-constant">AnonymousUser</span>.new
        <span class="hljs-keyword">end</span>
        <span class="hljs-function"><span class="hljs-keyword">def</span> </span>admin_required
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> admin?
                redirect <span class="hljs-string">"/login?<span class="hljs-subst">#{env[<span class="hljs-string">"REQUEST_PATH"</span>]}</span>"</span>
            <span class="hljs-keyword">end</span>
        <span class="hljs-keyword">end</span>
        <span class="hljs-function"><span class="hljs-keyword">def</span> </span>admin?
            c_user = current_user
            <span class="hljs-keyword">not</span> c_user.<span class="hljs-keyword">nil</span>? <span class="hljs-keyword">and</span> c_user.group==<span class="hljs-string">"admin"</span>
        <span class="hljs-keyword">end</span>
        <span class="hljs-function"><span class="hljs-keyword">def</span> </span>logged_in?
            (!session[<span class="hljs-string">'userhash'</span>].<span class="hljs-keyword">nil</span>?)&amp;&amp;<span class="hljs-variable">$redis</span>.get(<span class="hljs-string">'userhash:'</span>+session[<span class="hljs-string">'userhash'</span>])==session[<span class="hljs-string">'user'</span>]
        <span class="hljs-keyword">end</span>
        <span class="hljs-function"><span class="hljs-keyword">def</span> </span>login_required
            <span class="hljs-keyword">if</span> !logged_in?
                redirect <span class="hljs-string">"/login?<span class="hljs-subst">#{env[<span class="hljs-string">"REQUEST_PATH"</span>]}</span>"</span>
            <span class="hljs-keyword">end</span>
        <span class="hljs-keyword">end</span>
        <span class="hljs-function"><span class="hljs-keyword">def</span> </span>register email, pass
            email = email.downcase.strip
            <span class="hljs-keyword">if</span> email != <span class="hljs-string">"anon@websyn.ca"</span> <span class="hljs-keyword">and</span> <span class="hljs-constant">User</span>.get(email).<span class="hljs-keyword">nil</span>?
                user = <span class="hljs-constant">User</span>.create({<span class="hljs-symbol">:email=&gt;email</span>,<span class="hljs-symbol">:password=&gt;pass</span>})
                authenticate email, pass
                <span class="hljs-keyword">return</span> user
            <span class="hljs-keyword">elsif</span> authenticate email, pass
                <span class="hljs-keyword">return</span> current_user
            <span class="hljs-keyword">end</span>
            <span class="hljs-keyword">nil</span>
        <span class="hljs-keyword">end</span>
        <span class="hljs-function"><span class="hljs-keyword">def</span> </span>authenticate email, pass, expire=<span class="hljs-keyword">nil</span>
            email.downcase!
            user = <span class="hljs-constant">User</span>.get(email)
            <span class="hljs-keyword">if</span> user.<span class="hljs-keyword">nil</span>?
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>
            <span class="hljs-keyword">end</span>
            <span class="hljs-keyword">if</span> user.password==pass
                session_key = <span class="hljs-constant">SecureRandom</span>.uuid
                <span class="hljs-variable">$redis</span>.set(<span class="hljs-string">"userhash:<span class="hljs-subst">#{session_key}</span>"</span>,email)
                session[<span class="hljs-string">'userhash'</span>]=session_key
                session[<span class="hljs-string">'user'</span>]=email
                <span class="hljs-keyword">if</span> !expire.<span class="hljs-keyword">nil</span>?
                    <span class="hljs-variable">$redis</span>.expire(<span class="hljs-string">"userhash:<span class="hljs-subst">#{session_key}</span>"</span>,expire)
                <span class="hljs-keyword">end</span>
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>
            <span class="hljs-keyword">end</span>
            <span class="hljs-keyword">false</span>
        <span class="hljs-keyword">end</span>
        <span class="hljs-function"><span class="hljs-keyword">def</span> </span>logout
            <span class="hljs-variable">$redis</span>.del <span class="hljs-string">"userhash:<span class="hljs-subst">#{session[<span class="hljs-string">'userhash'</span>]}</span>"</span>
            session[<span class="hljs-string">'userhash'</span>]=<span class="hljs-keyword">nil</span>
            session[<span class="hljs-string">'user'</span>]=<span class="hljs-keyword">nil</span>
        <span class="hljs-keyword">end</span>
        <span class="hljs-function"><span class="hljs-keyword">def</span> </span>render_login_button
            <span class="hljs-keyword">if</span> logged_in?
               <span class="hljs-keyword">return</span> <span class="hljs-string">'&lt;a href="/logout" title="Sign Out"&gt;&lt;i class="fa fa-sign-out fa-lg"&gt;&lt;/i&gt;&lt;span class="hidden-phone"&gt; Sign Out&lt;/span&gt;&lt;/a&gt;'</span>
            <span class="hljs-keyword">else</span>
               <span class="hljs-keyword">return</span> <span class="hljs-string">'&lt;a href="/login" title="Sign In"&gt;&lt;i class="fa fa-sign-in fa-lg"&gt;&lt;/i&gt;&lt;span class="hidden-phone"&gt; Sign In&lt;/span&gt;&lt;/a&gt;'</span>
            <span class="hljs-keyword">end</span>
        <span class="hljs-keyword">end</span>
<span class="hljs-comment">=begin
        def is_cached
            if ENV["RACK_ENV"]=="development"
                return
            end
            tag = "url:#{request.url}"
            page = $redis.get(tag)
            if page and !logged_in?
              etag Digest::SHA1.hexdigest(page)
              ttl = $redis.ttl(tag)
              response.header['redis-ttl'] = ttl.to_s
              response.header['redis'] = 'HIT'
              return page
            end
        end
        def set_cache(page, time: 3600)
            etag Digest::SHA1.hexdigest(page)
            tag = "url:#{request.url}"
            response.header['redis'] = 'MISS'
            $redis.setex(tag, time, page) if !logged_in?
            return page
        end
=end</span>
        <span class="hljs-function"><span class="hljs-keyword">def</span> </span>cache <span class="hljs-symbol">time:</span> <span class="hljs-number">3600</span>, &amp;block
            <span class="hljs-keyword">if</span> <span class="hljs-constant">ENV</span>[<span class="hljs-string">"RACK_ENV"</span>]==<span class="hljs-string">"development"</span>
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">yield</span>
            <span class="hljs-keyword">end</span>
            tag = <span class="hljs-string">"url:<span class="hljs-subst">#{request.url}</span>"</span>
            page = <span class="hljs-variable">$redis</span>.get(tag)
            <span class="hljs-keyword">if</span> page
                etag <span class="hljs-constant">Digest::SHA1</span>.hexdigest(page)
                ttl = <span class="hljs-variable">$redis</span>.ttl(tag)
                response.header[<span class="hljs-string">'redis-ttl'</span>] = ttl.to_s
                response.header[<span class="hljs-string">'redis'</span>] = <span class="hljs-string">'HIT'</span>
            <span class="hljs-keyword">else</span>
                page = <span class="hljs-keyword">yield</span>
                etag <span class="hljs-constant">Digest::SHA1</span>.hexdigest(page)
                response.header[<span class="hljs-string">'redis'</span>] = <span class="hljs-string">'MISS'</span>
                <span class="hljs-variable">$redis</span>.setex(tag, time, page)
            <span class="hljs-keyword">end</span>
            page
        <span class="hljs-keyword">end</span>
        <span class="hljs-function"><span class="hljs-keyword">def</span> </span>document_auth doc_id=<span class="hljs-keyword">nil</span>
            doc_id ||= params[<span class="hljs-symbol">:doc</span>]
            <span class="hljs-keyword">if</span> doc_id.is_a? <span class="hljs-constant">String</span>
                doc_id = doc_id.decode62
            <span class="hljs-keyword">end</span>
            doc = <span class="hljs-constant">Document</span>.get doc_id
            <span class="hljs-keyword">if</span> doc.<span class="hljs-keyword">nil</span>?
                halt <span class="hljs-number">404</span>
            <span class="hljs-keyword">end</span>
            <span class="hljs-keyword">if</span> doc.visibility==<span class="hljs-string">"private"</span>
                perms = doc.permissions(<span class="hljs-symbol">user:</span>current_user)
                <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> logged_in?
                    redirect <span class="hljs-string">"/login?<span class="hljs-subst">#{env[<span class="hljs-string">"REQUEST_PATH"</span>]}</span>"</span>
                <span class="hljs-keyword">elsif</span> perms.length==<span class="hljs-number">0</span> <span class="hljs-comment"># isn't on the permission list</span>
                    status <span class="hljs-number">403</span>
                    halt <span class="hljs-number">403</span>
                <span class="hljs-keyword">end</span>
            <span class="hljs-keyword">end</span>
            <span class="hljs-keyword">return</span> doc_id, doc
        <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">end</span>

    configure <span class="hljs-symbol">:development</span> <span class="hljs-keyword">do</span>
        <span class="hljs-constant">Bundler</span>.<span class="hljs-keyword">require</span>(<span class="hljs-symbol">:development</span>)
        set <span class="hljs-symbol">:assets_debug</span>, <span class="hljs-keyword">true</span>
        use <span class="hljs-constant">PryRescue::Rack</span></pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Bypass a bug. Works correctly in production.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">end</span>

    configure <span class="hljs-symbol">:production</span> <span class="hljs-keyword">do</span>
        <span class="hljs-constant">Bundler</span>.<span class="hljs-keyword">require</span>(<span class="hljs-symbol">:production</span>)
        set <span class="hljs-symbol">:assets_css_compressor</span>, <span class="hljs-symbol">:sass</span>
        set <span class="hljs-symbol">:assets_js_compressor</span>, <span class="hljs-symbol">:closure</span>
        set <span class="hljs-symbol">:assets_precompile</span>, <span class="hljs-string">%w(default.css edit.css edit.scss bundle-norm.js bundle-edit.js)</span> <span class="hljs-comment"># *.woff *.png *.favico *.jpg *.svg *.eot *.ttf</span>
        no_digest = <span class="hljs-constant">Dir</span>.glob(<span class="hljs-constant">File</span>.join(root, <span class="hljs-string">'assets'</span>, <span class="hljs-string">'no_digest'</span>, <span class="hljs-string">"*.js"</span>)).map{|f| f.split(<span class="hljs-string">"/"</span>).last}
        set <span class="hljs-symbol">:assets_precompile_no_digest</span>, no_digest
    <span class="hljs-keyword">end</span>
    configure <span class="hljs-keyword">do</span>
        set <span class="hljs-symbol">:public_folder</span>, <span class="hljs-constant">File</span>.dirname(__FILE_<span class="hljs-number">_</span>) + <span class="hljs-string">'/../public'</span>
        set <span class="hljs-symbol">:views</span>, <span class="hljs-constant">File</span>.dirname(__FILE_<span class="hljs-number">_</span>)+<span class="hljs-string">"/../views"</span>
        use <span class="hljs-constant">Rack::Session::Cookie</span>, <span class="hljs-symbol">:expire_after</span> =&gt; <span class="hljs-number">60</span>*<span class="hljs-number">60</span>*<span class="hljs-number">24</span>*<span class="hljs-number">7</span>, <span class="hljs-symbol">:secret</span> =&gt; <span class="hljs-variable">$config</span>[<span class="hljs-string">'session_secret'</span>]
        enable <span class="hljs-symbol">:sessions</span>
        set <span class="hljs-symbol">:session_secret</span>, <span class="hljs-variable">$config</span>[<span class="hljs-string">'session_secret'</span>]
        set <span class="hljs-symbol">:server</span>, <span class="hljs-string">'thin'</span>
        set <span class="hljs-symbol">:sockets</span>, []
        disable <span class="hljs-symbol">:show_exceptions</span>
        disable <span class="hljs-symbol">:raise_errors</span>
        set <span class="hljs-symbol">:template_engine</span>, <span class="hljs-symbol">:erb</span>
        register <span class="hljs-constant">Sinatra::AssetPipeline</span>
        sprockets.append_path <span class="hljs-constant">File</span>.join(root, <span class="hljs-string">'assets'</span>, <span class="hljs-string">'stylesheets'</span>)
        sprockets.append_path <span class="hljs-constant">File</span>.join(root, <span class="hljs-string">'assets'</span>, <span class="hljs-string">'javascripts'</span>)
        sprockets.append_path <span class="hljs-constant">File</span>.join(root, <span class="hljs-string">'assets'</span>, <span class="hljs-string">'no_digest'</span>)
    <span class="hljs-keyword">end</span>
    get <span class="hljs-string">'/public'</span> <span class="hljs-keyword">do</span>
        cache <span class="hljs-symbol">time:</span> <span class="hljs-number">30</span> <span class="hljs-keyword">do</span>
            erb <span class="hljs-symbol">:public</span>
        <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">end</span>
    get <span class="hljs-string">'/login'</span> <span class="hljs-keyword">do</span>
        <span class="hljs-keyword">if</span> !logged_in?</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Cache the page if there is no URL redirect after login.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> request.query_string == <span class="hljs-string">""</span>
                cache <span class="hljs-keyword">do</span>
                    erb <span class="hljs-symbol">:login</span>
                <span class="hljs-keyword">end</span>
            <span class="hljs-keyword">else</span>
                erb <span class="hljs-symbol">:login</span>
            <span class="hljs-keyword">end</span>
        <span class="hljs-keyword">else</span>
            redirect <span class="hljs-string">'/'</span>
        <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">end</span>
    post <span class="hljs-string">'/login'</span> <span class="hljs-keyword">do</span>
        redirect_loc = <span class="hljs-string">'/'</span>
        <span class="hljs-keyword">if</span> params[<span class="hljs-symbol">:redirect</span>]!=<span class="hljs-string">''</span>
            redirect_loc = params[<span class="hljs-symbol">:redirect</span>]
        <span class="hljs-keyword">end</span>
        <span class="hljs-keyword">if</span> authenticate params[<span class="hljs-symbol">:email</span>],params[<span class="hljs-symbol">:password</span>]
            redirect redirect_loc
        <span class="hljs-keyword">else</span>
            redirect <span class="hljs-string">"/login?<span class="hljs-subst">#{redirect_loc}</span>"</span>
        <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">end</span>
    get <span class="hljs-string">'/register'</span> <span class="hljs-keyword">do</span>
        redirect <span class="hljs-string">'/login'</span>
    <span class="hljs-keyword">end</span>
    post <span class="hljs-string">'/register'</span> <span class="hljs-keyword">do</span>
        <span class="hljs-keyword">if</span> register params[<span class="hljs-symbol">:email</span>],params[<span class="hljs-symbol">:password</span>]
            redirect <span class="hljs-string">'/'</span>
        <span class="hljs-keyword">else</span>
            redirect <span class="hljs-string">'/login'</span>
        <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">end</span>
    get <span class="hljs-string">'/logout'</span> <span class="hljs-keyword">do</span>
        <span class="hljs-keyword">if</span> logged_in?
            logout
        <span class="hljs-keyword">end</span>
        redirect <span class="hljs-string">'/login'</span>
    <span class="hljs-keyword">end</span>
    not_found <span class="hljs-keyword">do</span>
        erb <span class="hljs-symbol">:error</span>, <span class="hljs-symbol">locals:</span>{<span class="hljs-symbol">error:</span> <span class="hljs-string">"404"</span>, <span class="hljs-symbol">reason:</span> <span class="hljs-string">"Page or document not found."</span>}
    <span class="hljs-keyword">end</span>
    error <span class="hljs-number">403</span> <span class="hljs-keyword">do</span>
        erb <span class="hljs-symbol">:error</span>, <span class="hljs-symbol">locals:</span>{<span class="hljs-symbol">error:</span> <span class="hljs-string">"403"</span>, <span class="hljs-symbol">reason:</span> <span class="hljs-string">"Access denied."</span>}
    <span class="hljs-keyword">end</span>
    error <span class="hljs-number">400</span> <span class="hljs-keyword">do</span>
        erb <span class="hljs-symbol">:error</span>, <span class="hljs-symbol">locals:</span>{<span class="hljs-symbol">error:</span> <span class="hljs-string">"400"</span>, <span class="hljs-symbol">reason:</span> <span class="hljs-string">"Invalid request."</span>}
    <span class="hljs-keyword">end</span>
    error <span class="hljs-number">500</span> <span class="hljs-keyword">do</span>
        erb <span class="hljs-symbol">:error</span>, <span class="hljs-symbol">locals:</span>{<span class="hljs-symbol">error:</span> <span class="hljs-string">"500"</span>, <span class="hljs-symbol">reason:</span> <span class="hljs-string">"The server failed to handle your request."</span>}
    <span class="hljs-keyword">end</span>
    get <span class="hljs-string">'/'</span> <span class="hljs-keyword">do</span>
        <span class="hljs-variable">@javascripts</span> = []
        <span class="hljs-keyword">if</span> logged_in?
            erb <span class="hljs-symbol">:file_list</span>
        <span class="hljs-keyword">else</span>
            cache <span class="hljs-keyword">do</span>
                erb <span class="hljs-symbol">:index</span>
            <span class="hljs-keyword">end</span>
        <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">end</span>
    get <span class="hljs-string">'/documentation'</span> <span class="hljs-keyword">do</span>
        cache <span class="hljs-keyword">do</span>
            erb <span class="hljs-symbol">:documentation</span>
        <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">end</span>
    get <span class="hljs-string">'/documentation/:file.:ext'</span> <span class="hljs-keyword">do</span>
        cache <span class="hljs-keyword">do</span>
            file = <span class="hljs-string">"docs/<span class="hljs-subst">#{params[<span class="hljs-symbol">:file</span>]}</span>.html"</span>
            <span class="hljs-keyword">if</span> <span class="hljs-constant">Dir</span>.glob(<span class="hljs-string">"docs/*.html"</span>).<span class="hljs-keyword">include</span>? file
                <span class="hljs-constant">File</span>.read file
            <span class="hljs-keyword">else</span>
                halt <span class="hljs-number">404</span>
            <span class="hljs-keyword">end</span>
        <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">end</span>
    get <span class="hljs-string">'/admin'</span> <span class="hljs-keyword">do</span>
        admin_required
        erb <span class="hljs-symbol">:admin</span>
    <span class="hljs-keyword">end</span>
    get <span class="hljs-string">'/admin/assets'</span> <span class="hljs-keyword">do</span>
        admin_required
        erb <span class="hljs-symbol">:admin_assets</span>
    <span class="hljs-keyword">end</span>
    get <span class="hljs-string">'/admin/assets/:asset/edit'</span> <span class="hljs-keyword">do</span>
        admin_required
        erb <span class="hljs-symbol">:admin_assets_edit</span>
    <span class="hljs-keyword">end</span>
    get <span class="hljs-string">'/admin/assets/:asset/delete'</span> <span class="hljs-keyword">do</span>
        admin_required
        ass = <span class="hljs-constant">Asset</span>.get(params[<span class="hljs-symbol">:asset</span>])
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> ass.<span class="hljs-keyword">nil</span>?
            ass.destroy
        <span class="hljs-keyword">end</span>
        redirect <span class="hljs-string">'/admin/assets'</span>
    <span class="hljs-keyword">end</span>
    post <span class="hljs-string">'/admin/assets/:asset/edit'</span> <span class="hljs-keyword">do</span>
        admin_required
        ass = <span class="hljs-constant">Asset</span>.get(params[<span class="hljs-symbol">:asset</span>])
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> ass.<span class="hljs-keyword">nil</span>?
            ass.name = params[<span class="hljs-symbol">:name</span>]
            ass.description = params[<span class="hljs-symbol">:desc</span>]
            ass.url = params[<span class="hljs-symbol">:url</span>]
            ass.type = params[<span class="hljs-symbol">:type</span>]
            ass.save
        <span class="hljs-keyword">else</span>
            n_ass = <span class="hljs-constant">Asset</span>.create(<span class="hljs-symbol">:name=&gt;params</span>[<span class="hljs-symbol">:name</span>],<span class="hljs-symbol">:description=&gt;params</span>[<span class="hljs-symbol">:desc</span>],<span class="hljs-symbol">:url=&gt;params</span>[<span class="hljs-symbol">:url</span>], <span class="hljs-symbol">:type=&gt;params</span>[<span class="hljs-symbol">:type</span>])
            n_ass.save
        <span class="hljs-keyword">end</span>
        redirect <span class="hljs-string">'/admin/assets'</span>
    <span class="hljs-keyword">end</span>
    get <span class="hljs-string">'/admin/asset_groups/:asset/edit'</span> <span class="hljs-keyword">do</span>
        admin_required
        erb <span class="hljs-symbol">:admin_asset_groups_edit</span>
    <span class="hljs-keyword">end</span>
    get <span class="hljs-string">'/admin/asset_groups/:asset_group/:asset/add'</span> <span class="hljs-keyword">do</span>
        admin_required
        ass = <span class="hljs-constant">AssetGroup</span>.get(params[<span class="hljs-symbol">:asset_group</span>])
        ass.assets &lt;&lt; <span class="hljs-constant">Asset</span>.get(params[<span class="hljs-symbol">:asset</span>])
        ass.save
        redirect <span class="hljs-string">"/admin/asset_groups/<span class="hljs-subst">#{params[<span class="hljs-symbol">:asset_group</span>]}</span>/edit"</span>
    <span class="hljs-keyword">end</span>
    get <span class="hljs-string">'/admin/asset_groups/:asset_group/:asset/remove'</span> <span class="hljs-keyword">do</span>
        admin_required
        ass = <span class="hljs-constant">AssetGroup</span>.get(params[<span class="hljs-symbol">:asset_group</span>])
        ass.assets.each <span class="hljs-keyword">do</span> |a|
            <span class="hljs-keyword">if</span> a.id==params[<span class="hljs-symbol">:asset</span>].to_i
                ass.assets.delete a
            <span class="hljs-keyword">end</span>
        <span class="hljs-keyword">end</span>
        ass.save
        redirect <span class="hljs-string">"/admin/asset_groups/<span class="hljs-subst">#{params[<span class="hljs-symbol">:asset_group</span>]}</span>/edit"</span>
    <span class="hljs-keyword">end</span>
    get <span class="hljs-string">'/admin/asset_groups/:asset/delete'</span> <span class="hljs-keyword">do</span>
        admin_required
        ass = <span class="hljs-constant">AssetGroup</span>.get(params[<span class="hljs-symbol">:asset</span>])
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> ass.<span class="hljs-keyword">nil</span>?
            ass.assets = []
            ass.save
            ass.destroy
        <span class="hljs-keyword">end</span>
        redirect <span class="hljs-string">'/admin/assets'</span>
    <span class="hljs-keyword">end</span>
    post <span class="hljs-string">'/admin/asset_groups/:asset/edit'</span> <span class="hljs-keyword">do</span>
        admin_required
        ass = <span class="hljs-constant">AssetGroup</span>.get(params[<span class="hljs-symbol">:asset</span>])
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> ass.<span class="hljs-keyword">nil</span>?
            ass.name = params[<span class="hljs-symbol">:name</span>]
            ass.description = params[<span class="hljs-symbol">:desc</span>]
            ass.save
        <span class="hljs-keyword">else</span>
            n_ass = <span class="hljs-constant">AssetGroup</span>.create(<span class="hljs-symbol">:name=&gt;params</span>[<span class="hljs-symbol">:name</span>],<span class="hljs-symbol">:description=&gt;params</span>[<span class="hljs-symbol">:desc</span>])
            n_ass.save
        <span class="hljs-keyword">end</span>
        redirect <span class="hljs-string">'/admin/assets'</span>
    <span class="hljs-keyword">end</span>
    get <span class="hljs-string">'/new/:group'</span> <span class="hljs-keyword">do</span>
        login_required
        group = <span class="hljs-constant">AssetGroup</span>.get(params[<span class="hljs-symbol">:group</span>])
        <span class="hljs-keyword">if</span> group.<span class="hljs-keyword">nil</span>?
            halt <span class="hljs-number">400</span>
        <span class="hljs-keyword">end</span>
        doc = <span class="hljs-constant">Document</span>.create(
            <span class="hljs-symbol">:name</span> =&gt; <span class="hljs-string">"Unnamed <span class="hljs-subst">#{group.name}</span>"</span>,
            <span class="hljs-symbol">:body</span> =&gt; {<span class="hljs-symbol">body:</span>[]},
            <span class="hljs-symbol">:created</span> =&gt; <span class="hljs-constant">Time</span>.now,
            <span class="hljs-symbol">:last_edit_time</span> =&gt; <span class="hljs-constant">Time</span>.now,
        )
        doc.assets = group.assets
        doc.save
        perm = <span class="hljs-constant">Permission</span>.create(<span class="hljs-symbol">user:</span> current_user, <span class="hljs-symbol">document:</span> doc, <span class="hljs-symbol">level:</span> <span class="hljs-string">"owner"</span>)
        redirect <span class="hljs-string">"/<span class="hljs-subst">#{doc.id.encode62}</span>/edit"</span>
    <span class="hljs-keyword">end</span>
    get <span class="hljs-string">'/upload'</span> <span class="hljs-keyword">do</span>
        login_required
        cache <span class="hljs-keyword">do</span>
            erb <span class="hljs-symbol">:upload</span>
        <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">end</span>
    post <span class="hljs-string">'/upload'</span> <span class="hljs-keyword">do</span>
        login_required
        <span class="hljs-keyword">if</span> params[<span class="hljs-symbol">:file</span>]==<span class="hljs-keyword">nil</span>
            redirect <span class="hljs-string">"/upload"</span>
        <span class="hljs-keyword">end</span>
        tempfile = params[<span class="hljs-symbol">:file</span>][<span class="hljs-symbol">:tempfile</span>]
        filename = params[<span class="hljs-symbol">:file</span>][<span class="hljs-symbol">:filename</span>]
        filetype = params[<span class="hljs-symbol">:file</span>][<span class="hljs-symbol">:type</span>]
        content = <span class="hljs-keyword">nil</span></pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>TODO: Split upload/download into its own external server. Right now Unoconv is blocking. Also issues may arise if multiple copies of LibreOffice are running on the same server. Should probably use a single server instance of LibreOffice</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        system(<span class="hljs-string">"unoconv"</span>,<span class="hljs-string">"-f"</span>,<span class="hljs-string">"html"</span>,tempfile.path)
        exit_status = <span class="hljs-variable">$?</span>.to_i
        <span class="hljs-keyword">if</span> exit_status == <span class="hljs-number">0</span>
            content = <span class="hljs-constant">File</span>.read(tempfile.path+<span class="hljs-string">".html"</span>)
        <span class="hljs-keyword">else</span>
            <span class="hljs-keyword">if</span> filetype==<span class="hljs-string">"application/pdf"</span>
                content = <span class="hljs-constant">PDFToHTMLR::PdfFilePath</span>.new(tempfile.path).convert.force_encoding(<span class="hljs-string">"UTF-8"</span>)
            <span class="hljs-keyword">elsif</span> filetype==<span class="hljs-string">'text/html'</span>
                content = <span class="hljs-constant">File</span>.read(tempfile.path)
            <span class="hljs-keyword">else</span>
                logger.info <span class="hljs-string">"Unoconv failed and Unrecognized filetype: <span class="hljs-subst">#{params[<span class="hljs-symbol">:file</span>][<span class="hljs-symbol">:type</span>]}</span>"</span>
            <span class="hljs-keyword">end</span>
        <span class="hljs-keyword">end</span>
        <span class="hljs-keyword">if</span> content!=<span class="hljs-keyword">nil</span></pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>TODO: Upload into JSON format</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            doc = Document.create(
                :name =&gt; filename,
                :body =&gt; {body:html_to_json(content)},
                :created =&gt; Time.now,
                :last_edit_time =&gt; Time.now,
                :user =&gt; current_user
            )
            doc.assets = AssetGroup.get(1).assets
            doc.save
            redirect "/#{doc.id.encode62}/edit"
        else
            redirect "/"
        end
    end
    get '/:doc/download/:format' do
        if !%w(bib doc docx doc6 doc95 docbook html odt ott ooxml pdb pdf psw rtf latex sdw sdw4 sdw3 stw sxw text txt vor vor4 vor3 xhtml bmp emf eps gif jpg met odd otg pbm pct pgm png ppm ras std svg svm swf sxd sxd3 sxd5 tiff wmf xpm odg odp pot ppt pwp sda sdd sdd3 sdd4 sti stp sxi vor5 csv dbf dif ods pts pxl sdc sdc4 sdc3 slk stc sxc xls xls5 xls95 xlt xlt5).include?(params[:format])
            halt 400
        end
        doc_id, doc = document_auth
        file = Tempfile.new('websync-export')
        file.write( json_to_html( doc.body['body'] ) )
        file.close
        system("unoconv","-f", params[:format], file.path)
        if $?.to_i==0
            export_file = file.path+"."+params[:format]
            response.headers['content_type'] = `file --mime -b export_file`.split(';')[0]
            attachment(doc.name+'.'+params[:format])
            response.write(File.read(export_file))
        else
            halt 500
        end
        file.unlink
    end
    get '/:doc/json' do
        doc_id, doc = document_auth
        content_type 'application/json'
        MultiJson.dump(doc.body)
    end
    get '/:doc/delete' do
        doc_id, doc = document_auth
        if doc.permissions(level: "owner").user[0]==current_user
            doc.destroy!
        else
            halt 403
        end
        redirect '/'
    end
    get // do
        parts = request.path_info.split("/")
        pass unless parts.length == 3
        doc = parts[1]
        op = parts[2]
        doc_id, doc = document_auth doc
        @javascripts = [</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>‘/assets/bundle-edit.js’</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        ]
        client_id = <span class="hljs-variable">$redis</span>.incr(<span class="hljs-string">"clientid"</span>)
        client_key = <span class="hljs-constant">SecureRandom</span>.uuid
        user = doc.permissions(<span class="hljs-symbol">user:</span> current_user)[<span class="hljs-number">0</span>]
        access = user.level <span class="hljs-keyword">if</span> user
        access ||= doc.default_level
        <span class="hljs-variable">$redis</span>.set <span class="hljs-string">"websocket:id:<span class="hljs-subst">#{client_id}</span>"</span>,current_user.email
        <span class="hljs-variable">$redis</span>.set <span class="hljs-string">"websocket:key:<span class="hljs-subst">#{client_id}</span>"</span>, client_key+<span class="hljs-string">":<span class="hljs-subst">#{doc_id}</span>"</span>
        <span class="hljs-variable">$redis</span>.expire <span class="hljs-string">"websocket:id:<span class="hljs-subst">#{client_id}</span>"</span>, <span class="hljs-number">60</span>*<span class="hljs-number">60</span>*<span class="hljs-number">24</span>*<span class="hljs-number">7</span>
        <span class="hljs-variable">$redis</span>.expire <span class="hljs-string">"websocket:key:<span class="hljs-subst">#{client_id}</span>"</span>, <span class="hljs-number">60</span>*<span class="hljs-number">60</span>*<span class="hljs-number">24</span>*<span class="hljs-number">7</span>
        erb <span class="hljs-symbol">:edit</span>, <span class="hljs-symbol">locals:</span>{<span class="hljs-symbol">no_bundle_norm:</span> <span class="hljs-keyword">true</span>, <span class="hljs-symbol">doc:</span> doc, <span class="hljs-symbol">no_menu:</span> <span class="hljs-keyword">true</span>, <span class="hljs-symbol">edit:</span> <span class="hljs-keyword">true</span>, <span class="hljs-symbol">client_id:</span> client_id, <span class="hljs-symbol">client_key:</span> client_key, <span class="hljs-symbol">op:</span> op, <span class="hljs-symbol">access:</span> access}
    <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
