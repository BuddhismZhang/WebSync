<!DOCTYPE html>

<html>
<head>
  <title>backend.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="core.html">
                core.js
              </a>
            
              
              <a class="source" href="edit.html">
                edit.js
              </a>
            
              
              <a class="source" href="chat.html">
                chat.js
              </a>
            
              
              <a class="source" href="drawing.html">
                drawing.js
              </a>
            
              
              <a class="source" href="equations.html">
                equations.js
              </a>
            
              
              <a class="source" href="note.html">
                note.js
              </a>
            
              
              <a class="source" href="page.html">
                page.js
              </a>
            
              
              <a class="source" href="presentation.html">
                presentation.js
              </a>
            
              
              <a class="source" href="resize.html">
                resize.js
              </a>
            
              
              <a class="source" href="spreadsheet.html">
                spreadsheet.js
              </a>
            
              
              <a class="source" href="tables.html">
                tables.js
              </a>
            
              
              <a class="source" href="backend.html">
                backend.js
              </a>
            
              
              <a class="source" href="main.html">
                main.rb
              </a>
            
              
              <a class="source" href="models.html">
                models.rb
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>backend.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>#!<span class="hljs-regexp">/usr/</span>bin/node

<span class="hljs-keyword">var</span> config = {};
<span class="hljs-keyword">var</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>);
<span class="hljs-keyword">var</span> jsonpatch = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fast-json-patch'</span>)
Base62 = <span class="hljs-built_in">require</span>(<span class="hljs-string">'base62'</span>);
redisLib = <span class="hljs-built_in">require</span>(<span class="hljs-string">'redis'</span>);
<span class="hljs-keyword">var</span> pg = <span class="hljs-built_in">require</span>(<span class="hljs-string">'pg'</span>);
md5 = <span class="hljs-built_in">require</span>(<span class="hljs-string">'MD5'</span>);
<span class="hljs-keyword">var</span> _ = <span class="hljs-built_in">require</span>(<span class="hljs-string">"underscore"</span>);


fs.readFile(<span class="hljs-string">'./config.json'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err, buffer)</span> {</span>
    config = <span class="hljs-built_in">JSON</span>.parse(buffer.toString());
    postgres = <span class="hljs-keyword">new</span> pg.Client(<span class="hljs-string">"tcp://"</span> + config.postgres);
    postgres.connect();
    redis = redisLib.createClient(config.redis.port, config.redis.host);
    <span class="hljs-keyword">var</span> WebSocketServer = <span class="hljs-built_in">require</span>(<span class="hljs-string">'ws'</span>).Server,
        wss = <span class="hljs-keyword">new</span> WebSocketServer({
            port: config.websocket.port
        });
    wss.on(<span class="hljs-string">'connection'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(ws)</span> {</span>
        console.log(<span class="hljs-string">"Connection: "</span>, ws.upgradeReq.url);
        <span class="hljs-keyword">var</span> url = ws.upgradeReq.url;
        <span class="hljs-keyword">var</span> base = url.split(<span class="hljs-string">'?'</span>)[<span class="hljs-number">0</span>];
        <span class="hljs-keyword">var</span> parts = base.split(<span class="hljs-string">'/'</span>);
        ws.sendJSON = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(json)</span> {</span>
            <span class="hljs-keyword">this</span>.send(<span class="hljs-built_in">JSON</span>.stringify(json));
        }
        console.log(parts)
        <span class="hljs-keyword">if</span> (parts[<span class="hljs-number">2</span>] == <span class="hljs-string">'edit'</span> || parts[<span class="hljs-number">2</span>] == <span class="hljs-string">'view'</span>) {
            <span class="hljs-keyword">var</span> doc_id = Base62.decode(parts[<span class="hljs-number">1</span>]);
            console.log(<span class="hljs-string">'Connection! (Document: '</span> + doc_id + <span class="hljs-string">')'</span>);
            <span class="hljs-keyword">var</span> authenticated = <span class="hljs-literal">false</span>;
            <span class="hljs-keyword">var</span> responded = <span class="hljs-literal">true</span>;
            <span class="hljs-keyword">var</span> redis_sock, client_id, user_email;

            <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">userAuth</span><span class="hljs-params">(callback)</span> {</span>
                <span class="hljs-keyword">var</span> info;
                postgres.query(<span class="hljs-string">"SELECT level FROM permissions WHERE document_id = $1 AND user_email = $2"</span>, [doc_id, user_email]).on(<span class="hljs-string">"row"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(row)</span> {</span>
                    info = row;
                }).on(<span class="hljs-string">"end"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
                    <span class="hljs-keyword">if</span> (info) {
                        callback(info.level);
                    } <span class="hljs-keyword">else</span> {
                        postgres.query(<span class="hljs-string">"SELECT visibility, default_level FROM documents WHERE id = $1"</span>, [doc_id])
                            .on(<span class="hljs-string">"row"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(row)</span> {</span>
                                <span class="hljs-keyword">if</span> (row.visibility == <span class="hljs-string">"private"</span>) {
                                    callback(<span class="hljs-string">"none"</span>);
                                } <span class="hljs-keyword">else</span> {
                                    callback(row.default_level);
                                }
                            });
                    }
                });
            }

            <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">needAuth</span><span class="hljs-params">(level, callback)</span> {</span>
                <span class="hljs-keyword">var</span> levels = [<span class="hljs-string">"none"</span>, <span class="hljs-string">"viewer"</span>, <span class="hljs-string">"editor"</span>, <span class="hljs-string">"owner"</span>]
                userAuth(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(auth)</span> {</span>
                    <span class="hljs-keyword">if</span> (levels.indexOf(auth) &gt;= levels.indexOf(level)) {
                        callback(auth);
                    } <span class="hljs-keyword">else</span> {
                        ws.sendJSON({
                            type: <span class="hljs-string">'error'</span>,
                            reason: <span class="hljs-string">'Invalid permissions.'</span>
                        });
                    }
                });
            }
            ws.sendJSON({
                type: <span class="hljs-string">'connected'</span>
            });
            ws.on(<span class="hljs-string">'message'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(message)</span> {</span>
                <span class="hljs-keyword">var</span> data = <span class="hljs-built_in">JSON</span>.parse(message);
                console.log(<span class="hljs-string">'JSON: '</span> + message);
                <span class="hljs-keyword">if</span> (data.type == <span class="hljs-string">'auth'</span>) {
                    client_id = data.id;
                    redis.get(<span class="hljs-string">'websocket:key:'</span> + data.id, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err, reply)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>console.log([“Keys!”, reply,data.key]);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        <span class="hljs-keyword">if</span> (reply == data.key + <span class="hljs-string">":"</span> + doc_id) {
                            console.log(<span class="hljs-string">'Client['</span> + data.id + <span class="hljs-string">'] Authed!'</span>);
                            authenticated = <span class="hljs-literal">true</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>TODO: Implement socket verification.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                            redis_sock = redisLib.createClient(config.redis.port, config.redis.host);
                            redis_sock.on(<span class="hljs-string">'message'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(channel, msg)</span> {</span>
                                console.log(<span class="hljs-string">'DocMsg['</span> + channel + <span class="hljs-string">'] '</span> + msg);
                                <span class="hljs-keyword">var</span> mdata = <span class="hljs-built_in">JSON</span>.parse(msg);
                                <span class="hljs-keyword">if</span> (mdata.client != client_id) {
                                    <span class="hljs-keyword">if</span> (mdata.type == <span class="hljs-string">'client_bounce'</span>) {
                                        ws.send(mdata.data);
                                    }
                                }
                            });
                            redis_sock.subscribe(<span class="hljs-string">'doc:'</span> + doc_id);
                            <span class="hljs-keyword">var</span> close = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
                                clearInterval(interval);
                                ws.close();
                                redis_sock.quit();
                                redis.get(<span class="hljs-string">'doc:'</span> + doc_id + <span class="hljs-string">':users'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err, reply)</span> {</span>
                                    <span class="hljs-keyword">var</span> users = <span class="hljs-built_in">JSON</span>.parse(reply);
                                    <span class="hljs-keyword">delete</span> users[client_id];
                                    redis.set(<span class="hljs-string">'doc:'</span> + doc_id + <span class="hljs-string">':users'</span>, <span class="hljs-built_in">JSON</span>.stringify(users));
                                    redis.publish(<span class="hljs-string">"doc:"</span> + doc_id, <span class="hljs-built_in">JSON</span>.stringify({
                                        type: <span class="hljs-string">"client_bounce"</span>,
                                        client: client_id,
                                        data: <span class="hljs-built_in">JSON</span>.stringify({
                                            type: <span class="hljs-string">"exit_user"</span>,
                                            id: client_id
                                        })
                                    }));
                                });
                            }
                            <span class="hljs-keyword">var</span> interval = setInterval(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
                                <span class="hljs-keyword">if</span> (!responded)
                                    close();
                                <span class="hljs-keyword">else</span> {
                                    responded = <span class="hljs-literal">false</span>;
                                    ws.sendJSON({
                                        type: <span class="hljs-string">'ping'</span>
                                    });
                                }
                            }, <span class="hljs-number">30</span> * <span class="hljs-number">1000</span>);
                            ws.on(<span class="hljs-string">'close'</span>, close);
                            redis.expire(<span class="hljs-string">'websocket:id:'</span> + client_id, <span class="hljs-number">60</span> * <span class="hljs-number">60</span> * <span class="hljs-number">24</span> * <span class="hljs-number">7</span>);
                            redis.expire(<span class="hljs-string">'websocket:key:'</span> + client_id, <span class="hljs-number">60</span> * <span class="hljs-number">60</span> * <span class="hljs-number">24</span> * <span class="hljs-number">7</span>);
                            redis.get(<span class="hljs-string">'websocket:id:'</span> + data.id, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err, email)</span> {</span>
                                redis.get(<span class="hljs-string">'doc:'</span> + doc_id + <span class="hljs-string">':users'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err, reply)</span> {</span>
                                    <span class="hljs-keyword">var</span> users = {};
                                    <span class="hljs-keyword">if</span> (reply) {
                                        users = <span class="hljs-built_in">JSON</span>.parse(reply);
                                    }
                                    user_id = md5(email.trim().toLowerCase());
                                    user_email = email;
                                    users[client_id] = {
                                        id: user_id,
                                        email: email.trim()
                                    };</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>TODO: Finish reimplementing the rest o’ this shiz.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                    redis.set(<span class="hljs-string">'doc:'</span> + doc_id + <span class="hljs-string">':users'</span>, <span class="hljs-built_in">JSON</span>.stringify(users));
                                    redis.publish(<span class="hljs-string">"doc:"</span> + doc_id, <span class="hljs-built_in">JSON</span>.stringify({
                                        type: <span class="hljs-string">"client_bounce"</span>,
                                        client: client_id,
                                        data: <span class="hljs-built_in">JSON</span>.stringify({
                                            type: <span class="hljs-string">"new_user"</span>,
                                            id: client_id,
                                            user: users[client_id]
                                        })
                                    }));
                                    ws.send(<span class="hljs-built_in">JSON</span>.stringify({
                                        type: <span class="hljs-string">'info'</span>,
                                        user_id: user_id,
                                        users: users
                                    }))
                                    console.log(<span class="hljs-string">"[Websocket Client Authed] ID: "</span> + client_id + <span class="hljs-string">", Email: "</span> + email);
                                });
                            });
                        } <span class="hljs-keyword">else</span> {
                            console.log(<span class="hljs-string">"INVALID KEY!!! CLOSING!!! WTF BOOM!!!"</span>);
                            ws.sendJSON({
                                type: <span class="hljs-string">"error"</span>,
                                reason: <span class="hljs-string">"Invalid Session. Please refresh the page."</span>
                            });
                            ws.close();
                        }
                    });
                } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (authenticated) {
                    userAuth(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(auth_level)</span> {</span>
                        <span class="hljs-keyword">var</span> editor = auth_level == <span class="hljs-string">"editor"</span> || auth_level == <span class="hljs-string">"owner"</span>;
                        <span class="hljs-keyword">if</span> (data.type == <span class="hljs-string">'load_scripts'</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>console.log(“LOADING SCRIPTS”);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                            <span class="hljs-keyword">var</span> ids = [];
                            postgres.query(<span class="hljs-string">"SELECT asset_id FROM asset_documents WHERE document_id = $1"</span>, [doc_id])
                                .on(<span class="hljs-string">'row'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(row)</span> {</span>
                                    ids.push(row.asset_id);
                                })
                                .on(<span class="hljs-string">'end'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
                                    <span class="hljs-keyword">var</span> js = [];
                                    <span class="hljs-keyword">var</span> css = [];
                                    ids.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value, index, arr)</span> {</span>
                                        postgres.query(<span class="hljs-string">"SELECT url, type FROM assets WHERE id = $1"</span>, [value])
                                            .on(<span class="hljs-string">'row'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(row)</span> {</span>
                                                <span class="hljs-keyword">if</span> (row.type == <span class="hljs-string">"Javascript"</span>) {
                                                    js.push(row.url);
                                                } <span class="hljs-keyword">else</span> {
                                                    css.push(row.url);
                                                }</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>console.log(“Lengths: “+js.length+”, “+css.length+”, “+ids.length+”. url = “+row.url);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                                <span class="hljs-keyword">if</span> ((js.length + css.length) == ids.length) {
                                                    <span class="hljs-keyword">var</span> msg = <span class="hljs-built_in">JSON</span>.stringify({
                                                        type: <span class="hljs-string">'scripts'</span>,
                                                        js: js,
                                                        css: css
                                                    });</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>console.log(“[MSG] “+msg);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                                    ws.send(msg);
                                                }
                                            });
                                    });
                                });
                        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (data.type == <span class="hljs-string">"share"</span>) {
                            userAuth(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(auth)</span> {</span>
                                <span class="hljs-keyword">if</span> (auth == <span class="hljs-string">"owner"</span>) {
                                    console.log(<span class="hljs-string">"1"</span>);
                                    postgres.query(<span class="hljs-string">"DELETE FROM permissions WHERE document_id = $1 AND user_email = $2"</span>, [doc_id, data.email])
                                        .on(<span class="hljs-string">"error"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err)</span> {</span>
                                            console.log(<span class="hljs-string">"2"</span>);
                                        })
                                        .on(<span class="hljs-string">"end"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
                                            <span class="hljs-keyword">if</span> (data.level != <span class="hljs-string">"delete"</span>) {
                                                console.log(<span class="hljs-string">"3"</span>);
                                                postgres.query(<span class="hljs-string">"INSERT INTO permissions (user_email, document_id, level) VALUES ($2, $1, $3)"</span>, [doc_id, data.email, data.level]);
                                            }
                                        });
                                } <span class="hljs-keyword">else</span> {
                                    ws.sendJSON({
                                        type: <span class="hljs-string">"error"</span>,
                                        reason: <span class="hljs-string">"Invalid permissions."</span>
                                    });
                                }
                            });
                        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (data.type == <span class="hljs-string">"permission_info"</span>) {
                            <span class="hljs-keyword">if</span> (auth_level == <span class="hljs-string">"editor"</span> || auth_level == <span class="hljs-string">"owner"</span>) {
                                <span class="hljs-keyword">var</span> perms;
                                postgres.query(<span class="hljs-string">"SELECT visibility, default_level FROM documents WHERE id = $1"</span>, [doc_id])
                                    .on(<span class="hljs-string">"row"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(row)</span> {</span>
                                        perms = row;
                                    })
                                    .on(<span class="hljs-string">"end"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
                                        perms.users = []
                                        postgres.query(<span class="hljs-string">"SELECT user_email, level FROM permissions WHERE document_id = $1"</span>, [doc_id])
                                            .on(<span class="hljs-string">"row"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(row)</span> {</span>
                                                perms.users.push(row);
                                            })
                                            .on(<span class="hljs-string">"end"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
                                                ws.sendJSON(_.extend({
                                                    type: <span class="hljs-string">"permissions"</span>
                                                }, perms));
                                            });
                                    });
                            } <span class="hljs-keyword">else</span> {
                                ws.sendJSON({
                                    type: <span class="hljs-string">"error"</span>,
                                    reason: <span class="hljs-string">"invalid permissions."</span>
                                });
                            }
                        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (data.type == <span class="hljs-string">"default_permissions"</span>) {
                            userAuth(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(auth)</span> {</span>
                                <span class="hljs-keyword">if</span> (auth == <span class="hljs-string">"owner"</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>TODO: Sanitize inputs. But whateva.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                    postgres.query(<span class="hljs-string">"UPDATE documents SET visibility=$1, default_level=$2 WHERE id = $3"</span>, [data.visibility, data.default_level, doc_id]);
                                } <span class="hljs-keyword">else</span> {
                                    ws.sendJSON({
                                        type: <span class="hljs-string">"error"</span>,
                                        reason: <span class="hljs-string">"Invalid permissions."</span>
                                    });
                                }
                            });
                        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (data.type == <span class="hljs-string">'ping'</span>) {
                            responded = <span class="hljs-literal">true</span>;
                        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (data.type == <span class="hljs-string">'config'</span>) {
                            <span class="hljs-keyword">if</span> (data.action == <span class="hljs-string">"get"</span>) {
                                postgres.query(<span class="hljs-string">"SELECT config FROM documents WHERE id = $1"</span>, [doc_id])
                                    .on(<span class="hljs-string">'row'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(row)</span> {</span>
                                        <span class="hljs-keyword">if</span> (data.space == <span class="hljs-string">'document'</span>) {
                                            <span class="hljs-keyword">var</span> doc_data = <span class="hljs-built_in">JSON</span>.parse(row.config);
                                            ws.send(<span class="hljs-built_in">JSON</span>.stringify({
                                                type: <span class="hljs-string">'config'</span>,
                                                action: <span class="hljs-string">'get'</span>,
                                                space: data.space,
                                                value: doc_data[data.property],
                                                id: data.id
                                            }));

                                        }</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>TODO: Implement user config</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                    });
                            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (data.action == <span class="hljs-string">"set"</span>) {}
                        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (data.type == <span class="hljs-string">"data_patch"</span> &amp;&amp; editor) {
                            postgres.query(<span class="hljs-string">"SELECT body FROM documents WHERE id = $1"</span>, [doc_id])
                                .on(<span class="hljs-string">"row"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(row)</span> {</span>
                                    <span class="hljs-keyword">var</span> body = <span class="hljs-built_in">JSON</span>.parse(row.body);
                                    <span class="hljs-keyword">try</span> {
                                        jsonpatch.apply(body, data.patch);
                                        postgres.query(<span class="hljs-string">"UPDATE documents SET body=$2,last_edit_time=$3 WHERE id = $1"</span>, [doc_id, <span class="hljs-built_in">JSON</span>.stringify(body), <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>()]);
                                        <span class="hljs-keyword">var</span> id = -<span class="hljs-number">1</span>;
                                        postgres.query(<span class="hljs-string">"SELECT id FROM changes WHERE document_id=$1 ORDER BY time DESC LIMIT 1;"</span>, [doc_id]).on(<span class="hljs-string">"row"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(row)</span> {</span>
                                            id = row.id;
                                        }).on(<span class="hljs-string">'end'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
                                            postgres.query(<span class="hljs-string">"INSERT INTO changes (time, patch, document_id, user_email, parent) VALUES ($3, $2, $1, $4, $5)"</span>, [doc_id, <span class="hljs-built_in">JSON</span>.stringify(data.patch), <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(), user_email, id]);
                                        });
                                        redis.publish(<span class="hljs-string">"doc:"</span> + doc_id, <span class="hljs-built_in">JSON</span>.stringify({
                                            type: <span class="hljs-string">'client_bounce'</span>,
                                            client: client_id,
                                            data: message
                                        }));
                                    } <span class="hljs-keyword">catch</span> (e) {
                                        console.log(<span class="hljs-string">"[data_patch] Error:"</span>, e);
                                        ws.send(<span class="hljs-built_in">JSON</span>.stringify({
                                            type: <span class="hljs-string">'error'</span>,
                                            msg: <span class="hljs-string">'Bad patch'</span>
                                        }));
                                    }
                                });
                        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (data.type == <span class="hljs-string">'name_update'</span> &amp;&amp; editor) {
                            console.log(<span class="hljs-string">"Update"</span>, doc_id, data.name);
                            postgres.query(<span class="hljs-string">"UPDATE documents SET name=$2,last_edit_time=$3 WHERE id = $1"</span>, [doc_id, data.name, <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>()], <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err)</span> {</span>
                                <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">throw</span> err;
                            });
                            redis.publish(<span class="hljs-string">"doc:"</span> + doc_id, <span class="hljs-built_in">JSON</span>.stringify({
                                type: <span class="hljs-string">'client_bounce'</span>,
                                client: client_id,
                                data: message
                            }));
                        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (data.type == <span class="hljs-string">'client_event'</span>) {
                            redis.publish(<span class="hljs-string">'doc:'</span> + doc_id, <span class="hljs-built_in">JSON</span>.stringify({
                                type: <span class="hljs-string">'client_bounce'</span>,
                                client: client_id,
                                data: <span class="hljs-built_in">JSON</span>.stringify({
                                    type: <span class="hljs-string">'client_event'</span>,
                                    event: data.event,
                                    from: client_id,
                                    data: data.data
                                })
                            }));
                        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (data.type == <span class="hljs-string">'assets'</span>) {
                            <span class="hljs-keyword">if</span> (data.action == <span class="hljs-string">'list'</span>) {
                                postgres.query(<span class="hljs-string">"SELECT * FROM assets ORDER BY name"</span>)
                                    .on(<span class="hljs-string">'row'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(row)</span> {</span>
                                        ws.send(<span class="hljs-built_in">JSON</span>.stringify({
                                            type: <span class="hljs-string">'asset_list'</span>,
                                            id: row.id,
                                            name: row.name,
                                            description: row.description,
                                            url: row.url,
                                            atype: row.type
                                        }));
                                    });
                            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (data.action == <span class="hljs-string">'add'</span> &amp;&amp; editor) {
                                postgres.query(<span class="hljs-string">"INSERT INTO asset_documents (document_id, asset_id) VALUES ($1, $2)"</span>, [doc_id, data.id]);
                            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (data.action == <span class="hljs-string">'delete'</span> &amp;&amp; editor) {
                                postgres.query(<span class="hljs-string">"DELETE FROM asset_documents WHERE document_id = $1 AND asset_id = $2"</span>, [doc_id, data.id]);
                            }
                        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (data.type == <span class="hljs-string">'diffs'</span>) {
                            <span class="hljs-keyword">if</span> (data.action == <span class="hljs-string">'list'</span>) {
                                <span class="hljs-keyword">var</span> patches = [];
                                postgres.query(<span class="hljs-string">"SELECT time, patch, user_email, id, parent FROM changes WHERE document_id=$1 ORDER BY time ASC"</span>, [doc_id])
                                    .on(<span class="hljs-string">'row'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(row)</span> {</span>
                                        patches.push(row);
                                    }).on(<span class="hljs-string">'end'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
                                        ws.send(<span class="hljs-built_in">JSON</span>.stringify({
                                            type: <span class="hljs-string">'diff_list'</span>,
                                            patches: patches
                                        }));
                                    });
                            }
                        }
                    });
                }
            });
        }
    });
    console.log(<span class="hljs-string">'WebSync WebSocket server is ready to receive connections.'</span>);
    console.log(<span class="hljs-string">'Listening on: 0.0.0.0:'</span> + config.websocket.port);
});</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
