
<html>
    <head>
        <script src="https://google-code-prettify.googlecode.com/svn/loader/run_prettify.js"></script>
        <script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
        <style>
            html {
                margin: 20px;
                overflow: auto !important;
            }
            body .script {
                word-wrap:break-word;
                display:none;
            }
            .well {
                min-height: 20px;
                padding: 19px;
                margin-bottom: 20px;
                background-color: #f5f5f5;
                border: 1px solid #e3e3e3;
                -webkit-border-radius: 4px;
                -moz-border-radius: 4px;
                border-radius: 4px;
                -webkit-box-shadow: inset 0 1px 1px rgba(0,0,0,0.05);
                -moz-box-shadow: inset 0 1px 1px rgba(0,0,0,0.05);
                box-shadow: inset 0 1px 1px rgba(0,0,0,0.05);
            }
            .todo {
                background-color: yellow;
            }
            .internal {
                background-color: red;
            }
            body, html {
                font-family: 'Helvetica';
            }
        </style>
    </head>
    <body>
        <h1>Web-Sync Client API</h1>
        <p>Many of these functions are for internal use only and are provided merely for completeness.</p>
            <h3>File: assets/javascripts/chat.js</h3>
            <hr>
                <div class='well'>
                <b>void [plugin=chat].disable();</b>
                <br>
                <i>Type: Function, Line: 111</i>
                <br>
                <span>Disables the plugin. This has to be set for possible plugin unloading.</span>
                </div>
            <h4><button class="btn btn-primary" onclick="$('#1').toggle(); false">View Source</a></h4>
            <pre class="script prettyprint linenums" id="1">// WebSync: Chat Plugin
// WebSync uses RequireJS for modules.
// define( [pluginName], [requiredModules], definition);
// pluginName is an optional argument that should only be used if the module is being bundled/loaded without RequireJS. It should match the path it's being required as.
define(['websync'],function(edit,websink){ var self = {};
    // Save all variables and information to the self object.

    // Plugins should use a jQuery namespace for ease of use.
	// Bind Example: $(document).bind("click.Tables", clickHandler);
	// Unbind Example: $("*").unbind(".Tables");
    self.open = false;
    $('body').append($('&#60;div id="chat" class="sidebar"&#62&#60;div id="user_list"&#62&#60;/div&#62&#60;div id="chat_well"&#62&#60;/div&#62&#60;div class="chat_input input-append"&#62&#60;input class="span2" id="appendedInputButton" type="text"&#62&#60;button id="msg_btn" class="btn" type="button"&#62Send&#60;/button&#62&#60;/div&#62&#60;/div&#62'));
    $('#settings').prepend($('&#60;li&#62&#60;a id="chat_btn" title="Chat"&#62&#60;img src="/chat.png"&#62&#60;/img&#62 &#60;span id="user_count" class="badge"&#621&#60;/span&#62&#60;/a&#62&#60;/li&#62'));
    $("#chat").offset({left:window.innerWidth+1});
    $("#chat img").tooltip();
    $(document).bind('client_load.Chat',function(e,data){
        console.log("Client_load",data);
        var client = data.client;
        var client_dom = $("#client_"+client);
        var user = WebSync.clients[client];
        var user_info = WebSync.users[user.id];
        if(client_dom.length&#620){
            if(user_info.displayName){
                client_dom.children().attr('data-original-title',_.escape(user_info.displayName));
            }
        } else {
            self.addUser(client);
        }
        self.updateUserList();
    });
    $("#msg_btn").bind('click.Chat',function(e){
        self.msg();
    });
    $(".chat_input input").bind('keypress.Chat',function(e){
        if(e.which==13){
            self.msg();
        }
    });
    $(document).bind("client_event_chat_msg.Chat",function(e,data){
        self.clientMsg(data.from,data.data);
    });
    self.msg = function(){
        var msg = $(".chat_input input").val();
        if(msg.length&#620){
            WebSync.broadcastEvent('chat_msg',msg);
            self.clientMsg(WebSyncAuth.id,msg);
            $(".chat_input input").val("");
        }
    }
    self.addUser = function(client){
        var user = WebSync.clients[client];
        var user_info = WebSync.users[user.id];
        var display_name = user_info.displayName;
        if(!display_name){
            display_name = user.email;
        }
        display_name = _.escape(display_name);
        $("#user_list").append('&#60;a target="_blank" id="client_'+client+'" href="https://secure.gravatar.com/'+user.id+'"&#62&#60;img data-toggle="tooltip" data-placement="bottom" title="'+display_name+'" src="https://secure.gravatar.com/avatar/'+user.id+'?size=38&d=http://i.imgur.com/xzn2nB0.png"&#62&#60;/img&#62&#60;/a&#62').children().last().children().tooltip();
    }
    $(document).bind('client_leave.Chat',function(e,data){
        console.log("Client leaving",data);
        $("#client_"+data.client).remove();
        self.updateUserList();
    });
    $(document).bind('noconnection.Chat',function(){
        $("#user_list").empty();
        self.updateUserList();
    });
    self.updateUserList = function(){setTimeout(function(){
        $("#user_count").text(_.size(WebSync.clients));
        $("#chat_well").css({top: $("#user_list").height()-5});
    },100);};
    self.clientMsg = function(client, msg){
        var user = WebSync.clients[client];
        var user_info = WebSync.users[user.id];
        var display_name = user_info.displayName;
        if(!display_name){
            display_name = user.email;
        }
        display_name = _.escape(display_name);
        $("#chat_well").append('&#60;p&#62&#60;a target="_blank" href="https://secure.gravatar.com/'+user.id+'"&#62&#60;img src="https://secure.gravatar.com/avatar/'+user.id+'?size=38&d=http://i.imgur.com/xzn2nB0.png"&#62&#60;/img&#62&#60;span&#62'+display_name+':&#60;/span&#62&#60;/a&#62 '+_.escape(msg)+'&#60;/p&#62');
        if(!self.open){
            $("#user_count").addClass("badge-pulse");
        }
        $("#chat_well").animate({scrollTop:$("#chat_well").get(0).scrollHeight},200);
    }
    self.toggle = function(){
        self.resize();
        $("#chat_btn").parent().toggleClass("active");
        if(self.open){
            $("#chat").animate({left:window.innerWidth+1},200);
            $(".content_well").animate({right: 0},200);
            self.open=false;
        } else {
            //$("#chat").animate({left:window.innerWidth-251},200);
            $("#user_count").removeClass("badge-pulse");
            self.open = true;
            self.resize();
        }
    }
    $("#chat_btn").bind("click.Chat",self.toggle);
    self.resize = function(e){
        if(self.open){
            $("#chat").animate({left:window.innerWidth-251},200);
            $('.content_well').animate({right:251},200);
        }
        $("#chat").height(window.innerHeight-$(".content_well").position().top)
    }
    self.resize();
    $(window).bind('resize.Chat',self.resize);
	// Function: void [plugin=chat].disable();
    // Disables the plugin. This has to be set for possible plugin unloading.
	self.disable = function(){
		$("#chat").remove();
        $("#chat_btn").remove();
        // Reset content_well width;
        $('.content_well').get(0).style.width=null;
		$("*").unbind(".Chat");
		$("*").undelegate(".Chat");
	}
    $.each(WebSync.clients,function(k, v){
        self.addUser(k);
        self.updateUserList();
    });

    // Return self so other modules can hook into this one.
    return self;
});</pre>
            <h3>File: assets/javascripts/core.js</h3>
            <hr>
                <div class='well'>
                <b>object WebSync;</b>
                <br>
                <i>Type: Variable, Line: 11</i>
                <br>
                <span>This is the core of WebSync. Everything is stored under the WebSync object except for websocket authentication information which is under WebSyncAuth, and the main WebSyncData object.</span>
                </div>
                <div class='well'>
                <b>object WebSync.tmp;</b>
                <br>
                <i>Type: Variable, Line: 14</i>
                <br>
                <span>Provides a location for temporary data to be stored.</span>
                </div>
                <div class='well'>
                <b>boolean WebSync.webSocketFirstTime;</b>
                <br>
                <i>Type: Variable, Line: 17</i>
                <br>
                <span>Websocket first connection?</span>
                </div>
                <div class='well'>
                <b>void WebSync.webSocketStart();</b>
                <br>
                <i>Type: Function, Line: 20</i>
                <br>
                <span>Creates the websocket for communication.</span>
                </div>
                <div class='well'>
                <b>object WebSync.webSocketCallbacks;</b>
                <br>
                <i>Type: Variable, Line: 35</i>
                <br>
                <span>An object with all of the callbacks for a websocket connection.</span>
                </div>
                <div class='well'>
                <b>void WebSync.config_set(string key, object value, string space);</b>
                <br>
                <i>Type: Function, Line: 194</i>
                <br>
                <span>Sends a request to the server to set config[key] to value. Space can be "user" or "document".</span>
                </div>
                <div class='well'>
                <b>void WebSync.config_get(string key, string space);</b>
                <br>
                <i>Type: Function, Line: 202</i>
                <br>
                <span>Sends a request to the server for the key value. Space can be "user" or "document".</span>
                </div>
                <div class='well'>
                <b>void WebSync.initialize();</b>
                <br>
                <i>Type: Function, Line: 214</i>
                <br>
                <span>This is where the core of WebSync initializes.</span>
                </div>
                <div class='well'>
                <b>string WebSync.viewMode;</b>
                <br>
                <i>Type: Variable, Line: 364</i>
                <br>
                <span>This is the current visual mode. This can be either 'zen' or 'normal'</span>
                </div>
                <div class='well'>
                <b>boolean WebSync.menuVisible;</b>
                <br>
                <i>Type: Variable, Line: 367</i>
                <br>
                <span>This tells you if the menu ribbon is visible or not. In zen mode it can disappear.</span>
                </div>
                <div class='well'>
                <b>void WebSync.updateRibbon();</b>
                <br>
                <i>Type: Function, Line: 446</i>
                <br>
                <span>This updates the ribbon buttons based on the content in the ribbon bar. <span class="todo">TODO:</span> Use registration system & persist menu between updates.</span>
                </div>
                <div class='well'>
                <b>void WebSync.loadScripts();</b>
                <br>
                <i>Type: Function, Line: 469</i>
                <br>
                <span>Checks server for plugin scripts to load.</span>
                </div>
                <div class='well'>
                <b>void WebSync.showHTML();</b>
                <br>
                <i>Type: Function, Line: 474</i>
                <br>
                <span>Converts visible text to HTML. <span class="todo">TODO:</span> Delete/figure something out.</span>
                </div>
                <div class='well'>
                <b>string WebSync.getHTML();</b>
                <br>
                <i>Type: Function, Line: 479</i>
                <br>
                <span>This will return sanitized document HTML. <span class="todo">TODO:</span> This should be migrated into the page handler.</span>
                </div>
                <div class='well'>
                <b>void WebSync.resize();</b>
                <br>
                <i>Type: Function, Line: 488</i>
                <br>
                <span>Event handler for when the window resizes. This is an <span class="internal">internal</span> method.</span>
                </div>
                <div class='well'>
                <b>void WebSync.checkDiff();</b>
                <br>
                <i>Type: Function, Line: 496</i>
                <br>
                <span>This is an <span class="internal">internal</span> method that executes every couple of seconds while the client is connected to the server. It checks to see if there have been any changes to document. If there are any changes it sends a message to a Web Worker to create a patch to transmit.</span>
                </div>
                <div class='well'>
                <b>void WebSync.insertAtCursor(jQuery node);</b>
                <br>
                <i>Type: Function, Line: 520</i>
                <br>
                <span>Inserts a DOM element at selection cursor. This is probably going to be deprecated.</span>
                </div>
                <div class='well'>
                <b>object WebSync.getCss();</b>
                <br>
                <i>Type: Function, Line: 536</i>
                <br>
                <span>Returns the calculated CSS for the current selection. Warning: This can cause the client to run slowly if used too much.</span>
                </div>
                <div class='well'>
                <b>void WebSync.applyCssToSelection(object css);</b>
                <br>
                <i>Type: Function, Line: 557</i>
                <br>
                <span>Applies css to the selection. Uses jQuery css object format. Warning: This is rather slow and shouldn't be overly used.</span>
                </div>
                <div class='well'>
                <b>void WebSync.alert(string Message);</b>
                <br>
                <i>Type: Function, Line: 563</i>
                <br>
                <span>Displays an alert message in the lower right hand corner of the window.</span>
                </div>
                <div class='well'>
                <b>void WebSync.error(string Message);</b>
                <br>
                <i>Type: Function, Line: 568</i>
                <br>
                <span>Displays an error message in the lower right hand corner of the window.</span>
                </div>
                <div class='well'>
                <b>void WebSync.success(string Message);</b>
                <br>
                <i>Type: Function, Line: 573</i>
                <br>
                <span>Displays a success message in the lower right hand corner of the window.</span>
                </div>
                <div class='well'>
                <b>void WebSync.info(string Message);</b>
                <br>
                <i>Type: Function, Line: 578</i>
                <br>
                <span>Displays an info message in the lower right hand corner of the window.</span>
                </div>
                <div class='well'>
                <b>void WebSync.alert_msg(string Message, string Classes);</b>
                <br>
                <i>Type: Function, Line: 583</i>
                <br>
                <span>Displays an message in the lower right hand corner of the window with css classes.</span>
                </div>
            <h4><button class="btn btn-primary" onclick="$('#2').toggle(); false">View Source</a></h4>
            <pre class="script prettyprint linenums" id="2">/*
    WebSync: Core.js
    This is the core file that runs the WebSync editor.

    Copyright (c) 2013. All Rights reserved.

    Tristan Rice
    rice (at) outerearth (dot) net
    http://tristanrice.name/
*/
// Variable: object WebSync;
// This is the core of WebSync. Everything is stored under the WebSync object except for websocket authentication information which is under WebSyncAuth, and the main WebSyncData object.
define('websync',{
    // Variable: object WebSync.tmp;
    // Provides a location for temporary data to be stored.
    tmp: {},
    // Variable: boolean WebSync.webSocketFirstTime;
    // Websocket first connection?
	webSocketFirstTime: true,
    // Function: void WebSync.webSocketStart();
    // Creates the websocket for communication.
	webSocketStart: function(){
        var protocol = 'ws';
        var path = window.location.hostname + ':4568';
        if(window.location.protocol=='https:'){
            protocol = 'wss';
            path = 'websocket.websyn.ca';
        }
		WebSync.connection = new WebSocket(protocol+"://"+path+window.location.pathname);
		WebSync.connection.onopen = WebSync.webSocketCallbacks.onopen;
		WebSync.connection.onclose = WebSync.webSocketCallbacks.onclose;
		WebSync.connection.onmessage = WebSync.webSocketCallbacks.onmessage;
		WebSync.connection.onerror = WebSync.webSocketCallbacks.onerror;
	},
    // Variable: object WebSync.webSocketCallbacks;
    // An object with all of the callbacks for a websocket connection.
	webSocketCallbacks: {
		onopen: function(e){
			console.log(e);
			WebSync.diffInterval = setInterval(WebSync.checkDiff,1000);
			$(".navbar-inner").removeClass("no-connection");
            $(document).trigger("connection");
			$("#connection_msg").remove();
			if(WebSync.webSocketFirstTime){
				WebSync.connection.sendJSON({type:'auth',id:WebSyncAuth.id,key:WebSyncAuth.key});
			} else {
				WebSync.connection.sendJSON({type:'auth',id:WebSyncAuth.id,key:WebSyncAuth.key});
				WebSync.success("&#60;strong&#62Success!&#60;/strong&#62 Connection restablished.");
			}
		},

		onclose: function(e){
			console.log(e);
			if(WebSync.diffInterval){
				clearInterval(WebSync.diffInterval);
				$(".navbar-inner").addClass("no-connection");
				WebSync.error("&#60;strong&#62Connection Lost!&#60;/strong&#62 Server is currently unavailable.").get(0).id="connection_msg";
				WebSync.diffInterval=null;
                $(document).trigger("noconnection");
			}
			setTimeout(WebSync.webSocketStart,2000);
		},
		onmessage: function(e){
			console.log(e);
			data = JSON.parse(e.data);
			console.log("Message data:",data);
			if(data.type=="scripts"){
                // Load scripts from server.
				require(data.js);
			}
            else if(data.type=='data_patch'){
                // Make sure there aren't any outstanding changes that need to be sent before patching document.
                // TODO: Make this work with webworkers
                WebSync.checkDiff();
                // Get start selection.
				var sel = getSelection();
                var range, startText,startOffset,endText,endOffset;
                if(sel.rangeCount&#620){
                    range = sel.getRangeAt(0);
                    startText = range.startContainer.nodeValue;
                    startOffset = range.startOffset;
                    endText = range.endContainer.nodeValue;
                    endOffset = range.endOffset;
                }
                WebSync.tmp.range = {
                    active: (sel.rangeCount&#620),
                    startText: startText,
                    startOffset: startOffset,
                    endText: endText,
                    endOffset: endOffset
                }
                // Patch the HTML.
                //WebSyncData = jsondiffpatch.patch(WebSyncData,data.patch);
                //WebSync.oldData = JSON.parse(JSON.stringify(WebSyncData));
                WebSync.worker.postMessage({cmd:'apply_patch',html:WebSyncData,patch:data.patch});
                $(document).trigger("data_patch",{patch: data.patch});
            }
			else if(data.type=="name_update"){
				$("#name").text(data.name);
			}
            else if(data.type=='config'){
                if(data.action=='get'){
                    if(data.property=='public'){
                        $("#public_mode").val(data.value ? "Public" : "Private");
                    }
                    else {
                        var callback = WebSync._config_callbacks[data.id]
                        if(callback){
                            callback(data.property,data.value,data.space);
                            delete WebSync._config_callbacks[data.id];
                        }
                    }
                }
            }
            else if(data.type=='info'){
				WebSync.webSocketFirstTime = false;
				WebSync.loadScripts();
                WebSync.connection.sendJSON({type:'config',action:'get',property:'public'});
                WebSync.clients = data['users'];
                var to_trigger = {};
                $.each(WebSync.clients,function(k,v){
                    if(!WebSync.users[v.id]){
                        to_trigger[v.id]=[k];
                        $.ajax({
                            url:"https://secure.gravatar.com/"+v.id+".json",
                            dataType:'jsonp',
                            timeout: 2000
                        }).done(function(data){
                            WebSync.users[v.id]=data.entry[0];
                        }).complete(function(){
                            $.each(to_trigger[v.id],function(i, item){
                                $(document).trigger('client_load',{client:item});
                            });
                        })
                        WebSync.users[v.id]={};
                    } else {
                        if(!to_trigger[v.id]){
                            $(document).trigger('client_load',{client:k});
                        } else {
                            to_trigger[v.id].push(k);
                        }
                    }
                });
            }
            else if(data.type=='new_user'){
                WebSync.clients[data['id']]=data['user'];
                var user_id = data['user'].id;
                var client_id = data['id']
                if(!WebSync.users[data['user'].id]){
                    $.ajax({
                        url:"https://secure.gravatar.com/"+data['user'].id+".json",
                        dataType:'jsonp'
                    }).done(function(data){
                        console.log(data);
                        WebSync.users[user_id]=data.entry[0];
                        $(document).trigger('client_load',{client:client_id});
                    }).fail(function(){
                        $(document).trigger('client_load',{client:client_id});
                    });
                    WebSync.users[data['user'].id]={};
                } else {
                    $(document).trigger('client_load',{client:data['id']});
                }
            }
            else if(data.type=='exit_user'){
                delete WebSync.clients[data['id']];
                $(document).trigger('client_leave',{client:data['id']});
            }
            else if(data.type=='client_event'){
                $(document).trigger('client_event_'+data.event,{from:data.from,data:data.data});
            }
            else if(data.type=='asset_list'){
                var row = $("&#60;tr&#62&#60;td&#62&#60;/td&#62&#60;td&#62&#60;/td&#62&#60;td&#62&#60;/td&#62&#60;td&#62&#60;/td&#62&#60;td width='102px'&#62&#60;div class='switch' &#62&#60;input type='checkbox' "+(($("script[src='"+data.url+"']").length&#620)? "checked" : "")+"/&#62&#60;/div&#62&#60;/td&#62&#60;/tr&#62");
                row.get(0).dataset['id']=data.id;
                var children = row.children();
                children.get(0).innerText = data.name;
                children.get(1).innerText = data.description;
                children.get(2).innerText = data.url;
                children.get(3).innerText = data.atype;
                $($(children.get(4)).children().get(0)).bootstrapSwitch();
                $("#assets tbody").append(row);
            }
		},
		onerror:function(e){
			console.log(e);
		}

	},
    broadcastEvent: function(event,data){
        WebSync.connection.sendJSON({type:'client_event',event: event, data: data});
    },
    users:{},
    _config_callbacks: {},
    // Function: void WebSync.config_set(string key, object value, string space);
    // Sends a request to the server to set config[key] to value. Space can be "user" or "document".
    config_set: function(key, value, space){
        if(space==null){
            space='document';
        }
        WebSync.connection.sendJSON({type:'config',action:'set', property: key, value: value, space: space});
    },
    // Function: void WebSync.config_get(string key, string space);
    // Sends a request to the server for the key value. Space can be "user" or "document".
    config_get: function(key, callback, space){
        var id = btoa(Date.now());
        if(callback){
            WebSync._config_callbacks[id]=callback;
        }
        if(space==null){
            space='document';
        }
        WebSync.connection.sendJSON({type:'config',action:'get', property: key, space: space, id: id});
    },
    // Function: void WebSync.initialize();
    // This is where the core of WebSync initializes.
	initialize: function(){
		this.webSocketStart();
        $("#public_mode").change(function(){
            WebSync.connection.sendJSON({type:'config',action:'set',property:'public',value: ($(this).val()=="Public")})
        });
		$("#name").blur(function(){
			var name = $(this).text();
			$(this).html(name);
            document.title = name+" - WebSync";
            WebSync.connection.sendJSON({type: "name_update", name: name});
		});
		$("#name").focus(function(){
			if(this.innerText=="Unnamed Document"){
                setTimeout(function(){
                    document.execCommand('selectAll');
                },100);
            }
		});
        $(".settings-popup").delegate('button','click',function(){ $(this.parentElement.children[0]).prop('disabled', function (_, val) { return ! val; }); $(this).toggleClass("active");});
		$(".menu, .content_well").bind("mousedown selectstart",function(e){ if(e.target.tagName!="SELECT"){return false;} });
		$("#name").bind("mousedown selectstart",function(e){ e.stopPropagation(); });
        $('#zoom_level').slider()
         .on('slide', function(e){
			var zoom = $('#zoom_level').data("slider").getValue()/100.0
			$(".content_well").children().css({"transform":"scale("+zoom+")"});
        });
        $('body').mousemove(function(e){
            if(WebSync.viewMode=='Zen'){
                if(e.pageY&#60;85&&!WebSync.menuVisible){
                    $(".menu").animate({top: 0},200);
                    WebSync.menuVisible = true;
                }
                else if(e.pageY&#6285&&WebSync.menuVisible) {
                    $(".menu").animate({top: -85},200);
                    WebSync.menuVisible = false;
                }
            }
        });
        $('#view_mode').change(function(){
            var mode = $('#view_mode').val();
            WebSync.viewMode = mode;
            if(mode=='Zen'){
                $("body").addClass("zen").resize();
                $("#zoom_level").data("slider").setValue(120);
                $("#zoom_level").trigger("slide");
                $(".menu").animate({top:-85},200);
            }
            else if(mode=='Presentation') {
                $("body").removeClass("edit").removeClass("zen").addClass("view").resize();
                window.history.pushState("","WebSync - Presentation Mode","view");
                $(".menu").animate({top: -85},200);
            }
            else {
                $("body").removeClass("zen").resize();
                $("#zoom_level").data("slider").setValue(100);
                $("#zoom_level").trigger("slide");
                $(".menu").animate({top: 0},200);
            }
        });
        require(['edit']);
		this.updateRibbon();
		rangy.init();
		console.log(rangy)
        $('#settingsBtn').click(function(){
			$(this.parentElement).toggleClass("active");
            $(".settings-popup").toggle();
            WebSync.resize();
		});
        $('.settings-popup .close').click(function(){
			$($("#settingsBtn").get(0).parentElement).toggleClass("active");
            $(".settings-popup").toggle();
        });
        this.worker = new Worker("/assets/edit-worker.js");
        this.worker.onmessage = function(e) {
            var data = e.data;
            console.log(data);
            if(data.cmd=='diffed'){
                if(data.patch){
                    setTimeout(function(){
                        WebSync.connection.sendJSON({type: "data_patch", patch: data.patch});
                    },10);
                }
            }
            else if(data.cmd=='patched'){
                WebSync.oldData = JSON.parse(JSON.stringify(data.json));
                WebSyncData = data.json;
                if(WebSync.fromJSON){
                    WebSync.fromJSON();
                }
                sel = WebSync.tmp.range;
                if(sel.active){
                    // Find all #text nodes.
                    var text_nodes = $(".content").find(":not(iframe)").addBack().contents().filter(function() {
                        return this.nodeType == 3;
                    });
                    var startText = sel.startText, startOffset = sel.startOffset, endText = sel.endText, endOffset = sel.endOffset;
                    var startNode = {};
                    var endNode = {};
                    console.log(text_nodes);
                    var startNodeDist = 99999;
                    var endNodeDist = 99999;
                    // Locate the start & end #text nodes based on a Levenstein string distance.
                    text_nodes.each(function(index, node){
                        var dist = levenshteinenator(node.nodeValue,startText);
                        if(dist&#60;startNodeDist){
                            startNode = node;
                            startNodeDist = dist;
                        }
                        dist = levenshteinenator(node.nodeValue,endText);
                        if(dist&#60;endNodeDist){
                            endNode = node;
                            endNodeDist = dist;
                        }
                    });
                    // Update the text range.
                    var range = document.createRange();
                    range.setStart(startNode,startOffset);
                    range.setEnd(endNode,endOffset);
                    window.getSelection().removeAllRanges();
                    window.getSelection().addRange(range);
                }
                // Prevent checkDiff() from sending updates for patches.
            }
            else if(data.cmd=='log'){
                console.log(data.msg);
            }
        }
        $("a[href='#assets']").click(function(){
            $("#assets tbody").html("");
            WebSync.connection.sendJSON({type:'assets',action:'list'});
        });
        $(".tab-pane#assets").delegate(".switch","switch-change", function(e, data){
            var id = e.target.parentElement.parentElement.dataset.id;
            var url = e.target.parentElement.parentElement.children[2].innerText;
            WebSync.connection.sendJSON({type:'assets',action: (data.value ? 'add' : 'delete'), id: id});
            if(data.value){
                require([url]);
            } else {
                require(url).disable();
                requirejs.undef(url);
            }
        });
		this.applier = rangy.createCssClassApplier("tmp");
		// TODO: Better polyfil for firefox not recognizing -moz-user-modify: read-write
        this.resize();
        $(window).resize(this.resize);
        //this.setupWebRTC();
	},
    // Variable: string WebSync.viewMode;
    // This is the current visual mode. This can be either 'zen' or 'normal'
    viewMode: 'normal',
    // Variable: boolean WebSync.menuVisible;
    // This tells you if the menu ribbon is visible or not. In zen mode it can disappear.
    menuVisible: true,
    // WARNING: Experimental & Unsupported in many browsers!
	// WebRTC Peer functionality. This will be used for communication between Clients. Video + Text chat hopefully.
	setupWebRTC: function(){
		if(WebSync.createPeerConnection()){
		    WebSync.createDataChannel();
        }
	},
	createPeerConnection: function() {
		var pc_config = {"iceServers": [{"url": "stun:stun.l.google.com:19302"}]};
		var pc_constraints = {"optional": [{"RtpDataChannels": true}]};
		// Force the use of a number IP STUN server for Firefox.
		if (webrtcDetectedBrowser == "firefox") {
			pc_config = {"iceServers":[{"url":"stun:23.21.150.121"}]};
		}
		try {
		// Create an RTCPeerConnection via the polyfill (adapter.js).
		WebSync.pc = new RTCPeerConnection(pc_config, pc_constraints);
		WebSync.pc.onicecandidate = WebSync.onIceCandidate;
		console.log("Created RTCPeerConnnection with:\n" +
			  "  config: \"" + JSON.stringify(pc_config) + "\";\n" +
			  "  constraints: \"" + JSON.stringify(pc_constraints) + "\".");
		} catch (e) {
			console.log("Failed to create PeerConnection, exception: " + e.message);
			alert("Cannot create RTCPeerConnection object; WebRTC is not supported by this browser.");
			return false;
		}

		WebSync.pc.onaddstream = WebSync.onRemoteStreamAdded;
		WebSync.pc.onremovestream = WebSync.onRemoteStreamRemoved;
		WebSync.pc.ondatachannel = WebSync.onDataChannel;
        return true;
	},
	createDataChannel: function() {
		WebSync.dataChannel = WebSync.pc.createDataChannel("chat",{reliable:false});
		WebSync.dataChannel.onopen = WebSync.reportEvent;
		WebSync.dataChannel.onclose = WebSync.reportEvent;
		WebSync.dataChannel.onerror = WebSync.reportEvent;
		WebSync.dataChannel.onmessage = WebSync.reportEvent;
	},
	setupPeerOffer: function(isCaller){
		if (isCaller)
		    WebSync.pc.createOffer(gotDescription);
		else
		    WebSync.pc.createAnswer(WebSync.pc.remoteDescription, gotDescription);

		function gotDescription(desc) {
		    pc.setLocalDescription(desc);
		    signalingChannel.send(JSON.stringify({ "sdp": desc }));
		}
	},
	reportEvent: function(event) {
		console.log(event);
	},
	onIceCanidate: function onIceCandidate(event) {
		if (event.candidate) {
		sendMessage({type: 'candidate',
			   label: event.candidate.sdpMLineIndex,
			   id: event.candidate.sdpMid,
			   candidate: event.candidate.candidate});
		} else {
		console.log("End of candidates.");
		}
	},
	onRemoteStreamAdded: function onRemoteStreamAdded(event) {
		console.log("Remote stream added.");
		reattachMediaStream(miniVideo, localVideo);
		attachMediaStream(remoteVideo, event.stream);
		remoteStream = event.stream;
		waitForRemoteVideo();
	},
	onRemoteStreamRemoved: function onRemoteStreamRemoved(event) {
		console.log("Remote stream removed.");
	},
	onDataChannel: function(event){
		console.log("Data Channel:",event);
	},
    // Function: void WebSync.updateRibbon();
    // This updates the ribbon buttons based on the content in the ribbon bar. TODO: Use registration system & persist menu between updates.
	updateRibbon: function(){
		var menu_buttons = "";
		$(".ribbon .container").each(function(elem){
			menu_buttons += '&#60;li&#62&#60;a&#62'+this.id+'&#60;/a&#62&#60;/li&#62'
		});
		$('#ribbon_buttons').html(menu_buttons);
		$('#ribbon_buttons li').click(function(e){
			$('#ribbon_buttons li').removeClass('active');
			$(this).addClass('active');
			$('.ribbon .container').hide();
			$("#"+$(this).text()).show();
            var offset = $(this).offset();
            var width = $(this).width();
            var active_pos = $("#ribbon_button_active").offset().left;
            var speed = Math.abs(offset.left-active_pos)*2;
            if(speed&#62500)
                speed = 0;
            $('#ribbon_button_active').animate({left:offset.left,width: width},speed,'linear');
		});
		$($('#ribbon_buttons li').get(2)).click();
	},
    // Function: void WebSync.loadScripts();
    // Checks server for plugin scripts to load.
	loadScripts: function(){
		WebSync.connection.sendJSON({type: "load_scripts"});
	},
    // Function: void WebSync.showHTML();
    // Converts visible text to HTML. TODO: Delete/figure something out.
	showHTML: function(){
		$('.page').html("&#60;code&#62"+WebSync.getHTML()+"&#60;/code&#62");
	},
    // Function: string WebSync.getHTML();
    // This will return sanitized document HTML. TODO: This should be migrated into the page handler.
	getHTML: function(){
        $(".page").get(0).normalize();
		var html = $(".page").html().trim();
		// Remove other cursors.
		html = html.replace(/\&#60;cursor[^\/]+\/?\&#60;\/cursor\&#62/g,"")
		return html;
	},
    // Function: void WebSync.resize();
    // Event handler for when the window resizes. This is an internal method.
    resize: function(){
        //$(".content_well").height(window.innerHeight-$(".content_well").position().top);
        var width = window.innerWidth-260;
        $(".settings-popup").css({left:(window.innerWidth-(width+4))*0.5, width: width})
        $(".arrow").offset({left:$("#settingsBtn").parent().offset().left+15})
    },
    // Function: void WebSync.checkDiff();
    // This is an internal method that executes every couple of seconds while the client is connected to the server. It checks to see if there have been any changes to document. If there are any changes it sends a message to a Web Worker to create a patch to transmit.
	checkDiff: function(){
        if(!WebSync.oldData){
            WebSync.oldDataString = JSON.stringify(WebSyncData);
            WebSync.oldData = JSON.parse(WebSync.oldDataString);
        }
        if(WebSync.toJSON){
            WebSync.toJSON();
        }
        var stringWebSync = JSON.stringify(WebSyncData);
		if(stringWebSync!=WebSync.oldDataString){
            // Send it to the worker thread for processing.
            var msg = {'cmd':'diff','oldHtml':WebSync.oldData,'newHtml':WebSyncData};
            WebSync.worker.postMessage(msg);
            WebSync.oldData = JSON.parse(stringWebSync);
            WebSync.oldDataString = stringWebSync;
            /*var patch = jsondiffpatch.diff(WebSync.oldData,WebSyncData);
            if(patch){
                WebSync.connection.sendJSON({type: "data_patch", patch: patch});
			    WebSync.oldData = JSON.parse(JSON.stringify(WebSyncData));
            }*/
		}
	},
    // Function: void WebSync.insertAtCursor(jQuery node);
    // Inserts a DOM element at selection cursor. This is probably going to be deprecated.
	insertAtCursor: function(node) {
		node = node.get(0);
		var sel, range, html;
		if (window.getSelection) {
			sel = window.getSelection();
			if (sel.getRangeAt && sel.rangeCount) {
				range = sel.getRangeAt(0);
				range.deleteContents();
				range.insertNode( node );
			}
		} else if (document.selection && document.selection.createRange) {
			document.selection.createRange().html = node;
		}
	},
    // Function: object WebSync.getCss();
    // Returns the calculated CSS for the current selection. Warning: This can cause the client to run slowly if used too much.
	getCss: function(){
		/*WebSync.applier.toggleSelection();
		if($(".tmp").length==0) return {};
		return $(".tmp").removeClass("tmp").getStyleObject();*/
        var selection = getSelection();
        if(selection.type=="None"){
            return {};
        }
        var selNode = getSelection().baseNode.parentNode;
        if(WebSync.tmp.lastSelNode == selNode){
            return WebSync.tmp.lastSelCss;
        }
        else {
            var css_object = $(selNode).getStyleObject();
            WebSync.tmp.lastSelCss=css_object;
            WebSync.tmp.lastSelNode = selNode;
            return css_object;
        }
	},
    // Function: void WebSync.applyCssToSelection(object css);
	// Applies css to the selection. Uses jQuery css object format. Warning: This is rather slow and shouldn't be overly used.
	applyCssToSelection: function(css){
		WebSync.applier.toggleSelection();
		$(".tmp").css(css).removeClass("tmp");
	},
    // Function: void WebSync.alert(string Message);
    // Displays an alert message in the lower right hand corner of the window.
	alert: function(msg){
		return WebSync.alert_msg(msg,"");
	},
    // Function: void WebSync.error(string Message);
    // Displays an error message in the lower right hand corner of the window.
	error: function(msg){
		return WebSync.alert_msg(msg,"alert-error");
	},
    // Function: void WebSync.success(string Message);
    // Displays a success message in the lower right hand corner of the window.
	success: function(msg){
		return WebSync.alert_msg(msg,"alert-success");
	},
    // Function: void WebSync.info(string Message);
    // Displays an info message in the lower right hand corner of the window.
	info: function(msg){
		return WebSync.alert_msg(msg,"alert-info");
	},
    // Function: void WebSync.alert_msg(string Message, string Classes);
    // Displays an message in the lower right hand corner of the window with css classes.
	alert_msg: function(msg,classes){
		var div = $('&#60;div class="alert '+classes+'"&#62&#60;a class="close" data-dismiss="alert"&#62&times;&#60;/a&#62'+msg+'&#60;/div&#62');
		$('#alert_well').prepend(div);
		setTimeout(function(){
			div.alert('close');
		},10000);
		return div;
	}
});
dmp = new diff_match_patch();
function NODEtoJSON(obj){
    var jso = {
        name: obj.nodeName,
        childNodes:[]
    }
    if(obj.nodeName=="#text"){
        jso.textContent = obj.textContent;
    }
    if(obj.attributes){
        $.each(obj.attributes,function(k,v){
            // TODO: Add blacklist of classnames & attributes for DOM serialization.
            if(v.name!="contenteditable"){
                jso[v.name]=v.value;
            }
        });
    }
    $.each(obj.childNodes,function(index,child){
        jso.childNodes.push(NODEtoJSON(child));
    });
    if(_.isEmpty(jso.childNodes)){
        delete jso.childNodes;
    }
    return jso;
}
function DOMToJSON(obj){
    var jso = [];
    $.each(obj,function(index, elem){
        elem.normalize();
        jso.push(NODEtoJSON(elem));
    });
    return jso;
}
function NODEtoDOM(obj){
    var html = "";
    if(obj.name=="#text"){
        return obj.textContent;
    }
    html+="&#60;"+obj.name;
    $.each(obj,function(k,v){
        if(k!="name"&&k!="textContent"&&k!="childNodes"){
            html+=" "+k+"="+JSON.stringify(v);
        }
    });

    if(obj.childNodes){
        html+="&#62";
        $.each(obj.childNodes,function(index, elem){
            html+= NODEtoDOM(elem);
        });
        html+="&#60;/"+obj.name+"&#62";
    }
    else {
        html+="/&#62";
    }
    return html;
}
function JSONToDOM(obj){
    var html = "";
    $.each(obj,function(index,elem){
        html += NODEtoDOM(elem);
    });
    return html;
}
// Finds differences between obj1 and obj2.
function diff(obj1, obj2){
    var diffs = {}
    if(_.isEqual(obj1,obj2)){
    } else if(typeof(obj2)=='undefined'){
        diffs = {op:'delete'}
    } else if(typeof(obj1)!=typeof(obj2)){
        diffs = {op:'replace',new:obj2};
    } else if(typeof(obj1)=="string"){
        diffs = {op:'patch',patch:dmp.patch_toText(dmp.patch_make(obj1,obj2))}
    } else if($.isArray(obj1)){
        diffs = [];
        var C = []
        // Generate a table of matching areas.
        $.each(obj2,function(i1,val1){
            C[i1]=[]
            $.each(obj1,function(i2,val2){
                if(_.isEqual(val1,val2)){
                    C[i1][i2]=true;
                }
            });
        });
        log_array(C);
        // First pass through C looking for non-matching patterns found in the new array.
        var last_i2 = 0;
        var last_i1 = 0;
        $.each(C,function(i1,R){
            var exists = false;
            $.each(R,function(i2,val){
                // This deletes duplicates.
                if(val&&exists){
                    delete C[i1][i2];
                } else if(val){
                    exists = true;
                    /*var x = last_i1;
                    var y = last_i2;
                    while(x!=i1&&y!=i2){
                        var slope_x = 0;
                        var slope_y = 0;
                        if(x!=i1){
                            slope_x = 1;
                        }
                        if(y!=i2){
                            slope_y = 1;
                        }
                        x+=slope_x;
                        y+=slope_y;
                        if(!C[x][y]){
                            if(slope_x&&slope_y){
                                console.log(x,y,obj1,obj2);
                                diffs.push({op:'diff',index:i2,diff:diff(obj1[y-1],obj2[x])});
                            } else if(slope_x){
                                diffs.push({op:'new',new:obj2[x],index:x});
                            } else if(slope_y){
                                diffs.push({op:'delete',index:y});
                            }
                        }
                        for(var b=(x+2);b&#60;C.length;b++){
                            // Prune the rest of the false positives on this line.
                            delete C[b][y];
                        }
                    }//*/
                    for(var y=(last_i2);y&#60;i2;y++){
                        for(var b=(i1+1);b&#60;C.length;b++){
                            // Prune the rest of the false positives on this line.
                            delete C[b][y];
                        }
                    }
                    last_i2 = i2;
                    last_i1 = i1;
                }
            });
            if(!exists){
                var action = {op:'new',new:obj2[i1],index:i1}
                last_i2++;
                for(var x=(i1+1);x&#60;C.length;x++){
                        // Prune the rest of the false positives on this line.
                    delete C[x][last_i2];
                }
                diffs.push(action)
            }
        });
        // Second pass through C looking for non-matching patterns found in the old array.
        for(var i1=0;i1&#60;obj1.length;i1++){
            var exists = false;
            for(var i2=0;i2&#60;obj2.length;i2++){
                if(C[i2][i1]){
                    exists = true;
                }
            }
            if(!exists){
                diffs.push({op:'delete',index:i1})
            }
        }//*/
        /*var tmp_diff = [];
        for(var i=(diffs.length-1);i&#62=0;i--){
            var diff = diffs[i];
            var diff_index = tmp_diff[diff.index];
            if(diff_index!=null){
                {op:'diff',diff:diff(obj1[diff_index],obj2[diff_index]);
                delete diffs[diff_index];
                delete diffs[i];
            } else {
                tmp_diff[diff.index]=i;
            }
        }*/
        log_array(C);
    } else {
        // Both Objects
        $.each(obj1, function(k,v){
            var val = diff(v,obj2[k]);
            if(!_.isEmpty(val)){
                diffs[k]=val;
            }
        });
    }
    return diffs;
}
function log_array(arr){
    var output = "";
    $.each(arr,function(i1,R){
        var exists = false;
        $.each(R,function(i2,val){
            if(val){
                output+='0';
            } else {
                output+=' ';
            }
        });
        output += "\n";
    });
    console.log(output);

}
WebSocket.prototype.sendJSON = function(object){
	this.send(JSON.stringify(object));
}
function capitaliseFirstLetter(string)
{
    return string.charAt(0).toUpperCase() + string.slice(1);
}

requirejs.config({
    baseUrl: 'assets'
});
$(document).ready(function(){
    require(['websync'],function(websync){
        window.WebSync = websync;
        WebSync.initialize();
    });
});


// Polyfill for non-standard webkit method scrollIntoViewIfNeeded by Hubert SABLONNIERE @hsablonniere
if (!Element.prototype.scrollIntoViewIfNeeded) {
  Element.prototype.scrollIntoViewIfNeeded = function (centerIfNeeded) {
    centerIfNeeded = arguments.length === 0 ? true : !!centerIfNeeded;
    var parent = this.parentNode,
        parentComputedStyle = window.getComputedStyle(parent, null),
        parentBorderTopWidth = parseInt(parentComputedStyle.getPropertyValue('border-top-width')),
        parentBorderLeftWidth = parseInt(parentComputedStyle.getPropertyValue('border-left-width')),
        overTop = this.offsetTop - parent.offsetTop &#60; parent.scrollTop,
        overBottom = (this.offsetTop - parent.offsetTop + this.clientHeight - parentBorderTopWidth) &#62 (parent.scrollTop + parent.clientHeight),
        overLeft = this.offsetLeft - parent.offsetLeft &#60; parent.scrollLeft,
        overRight = (this.offsetLeft - parent.offsetLeft + this.clientWidth - parentBorderLeftWidth) &#62 (parent.scrollLeft + parent.clientWidth),
        alignWithTop = overTop && !overBottom;
    if ((overTop || overBottom) && centerIfNeeded) {
      parent.scrollTop = this.offsetTop - parent.offsetTop - parent.clientHeight / 2 - parentBorderTopWidth + this.clientHeight / 2;
    }
    if ((overLeft || overRight) && centerIfNeeded) {
      parent.scrollLeft = this.offsetLeft - parent.offsetLeft - parent.clientWidth / 2 - parentBorderLeftWidth + this.clientWidth / 2;
    }
    if ((overTop || overBottom || overLeft || overRight) && !centerIfNeeded) {
      this.scrollIntoView(alignWithTop);
    }
  };
}</pre>
            <h3>File: assets/javascripts/edit.js</h3>
            <hr>
                <div class='well'>
                <b>void [plugin=TextEdit].enable();</b>
                <br>
                <i>Type: Function, Line: 6</i>
                <br>
                <span>Enables the TextEdit plugin.</span>
                </div>
                <div class='well'>
                <b>void [plugin=TextEdit].disable();</b>
                <br>
                <i>Type: Function, Line: 76</i>
                <br>
                <span>Disables the TextEdit plugin.</span>
                </div>
                <div class='well'>
                <b>void [plugin=TextEdit].selectHandler();</b>
                <br>
                <i>Type: Function, Line: 84</i>
                <br>
                <span>Handling function for displaying accurate information about text in ribbon.</span>
                </div>
            <h4><button class="btn btn-primary" onclick="$('#3').toggle(); false">View Source</a></h4>
            <pre class="script prettyprint linenums" id="3">// WebSync: Text Editing Plugin
define("edit",['websync'],function(websync){ var self = this;
	// Plugins should use a jQuery namespace for ease of use.
	// Bind Example: $(document).bind("click.Tables", clickHandler);
	// Unbind Example: $("*").unbind(".Tables");
    // Function: void [plugin=TextEdit].enable();
    // Enables the TextEdit plugin.
    self.text_buttons= ["bold",'italic','strikethrough','underline','justifyleft','justifycenter','justifyright','justifyfull',"removeFormat","insertorderedlist","insertunorderedlist"];
    // Add ribbon text
    $(".ribbon").append('&#60;div id="Text" class="container"&#62 \
            &#60;button id="bold" title="Bold" class="btn"&#62&#60;i class="icon-bold"&#62&#60;/i&#62&#60;/button&#62 \
            &#60;button id="italic" title="Italic" class="btn"&#62&#60;i class="icon-italic"&#62&#60;/i&#62&#60;/button&#62 \
            &#60;button id="strikethrough" title="Strikethrough" class="btn"&#62&#60;i class="icon-strikethrough"&#62&#60;/i&#62&#60;/button&#62 \
            &#60;button id="underline" title="Underline" class="btn"&#62&#60;i class="icon-underline"&#62&#60;/i&#62&#60;/button&#62 \
            &#60;select id="font" title="Font" class="ribbon_button"&#62 \
            &#60;/select&#62 \
            &#60;select id="font_size" title="Font Size" class="ribbon_button"&#62 \
                &#60;option&#628pt&#60;/option&#62 \
                &#60;option&#6210pt&#60;/option&#62 \
                &#60;option&#6211pt&#60;/option&#62 \
                &#60;option&#6212pt&#60;/option&#62 \
                &#60;option&#6214pt&#60;/option&#62 \
                &#60;option&#6224pt&#60;/option&#62 \
                &#60;option&#6236pt&#60;/option&#62 \
            &#60;/select&#62 \
            &#60;div class="btn-group"&#62 \
                &#60;button id="justifyleft" title="Justify Left" class="btn"&#62&#60;i class="icon-align-left"&#62&#60;/i&#62&#60;/button&#62 \
                &#60;button id="justifycenter" title="Justify Center" class="btn"&#62&#60;i class="icon-align-center"&#62&#60;/i&#62&#60;/button&#62 \
                &#60;button id="justifyright" title="Justify Right" class="btn"&#62&#60;i class="icon-align-right"&#62&#60;/i&#62&#60;/button&#62 \
                &#60;button id="justifyfull" title="Justify Full" class="btn"&#62&#60;i class="icon-align-justify"&#62&#60;/i&#62&#60;/button&#62 \
            &#60;/div&#62 \
            &#60;button id="insertunorderedlist" title="Unordered List" class="btn"&#62&#60;i class="icon-list-ul"&#62&#60;/i&#62&#60;/button&#62 \
            &#60;button id="insertorderedlist" title="Ordered List" class="btn"&#62&#60;i class="icon-list-ol"&#62&#60;/i&#62&#60;/button&#62 \
            &#60;button id="removeFormat" title="Clear Formatting" class="btn"&#62&#60;i class="icon-remove"&#62&#60;/i&#62&#60;/button&#62 \
        &#60;/div&#62');
    this.text_buttons.forEach(function(elem){
        $('button#'+elem).bind("click.TextEdit",function(){
            document.execCommand(elem);
            //$(this).toggleClass("active");
            $(document).trigger('selectionchange');
        });
    });
    // Reflects text in menu at top
    $(document).bind('selectionchange.TextEdit',function(){
        if(!self._selectTimeout){
            self._selectTimeout = setTimeout(self.selectHandler,200);
        }
    });
    $(".content_well").bind("keydown.TextEdit","li",function(e){
        //console.log(e);
        if(e.keyCode==9){
            //console.log(this);
            var selection = document.getSelection();
            if(selection.type!="None" && !_.isNull(selection.baseNode)){
                var list_index = selection.baseNode;
                while(list_index.tagName!="LI"){
                    list_index = list_index.parentElement;
                }
                var indent = parseInt($(list_index).getStyleObject().marginLeft)+(e.shiftKey ? -40 : 40);
                if(indent&#60;0){
                    indent=0;
                }
                $(list_index).animate({marginLeft: indent+"px"},{duration:200,queue:true});
                e.preventDefault();
            }
        }
    });
    $('#font').bind("change.TextEdit",function(){
        document.execCommand('fontname',false,$('#font').val());
    });
    $('#font_size').change(function(){
        var size = $('#font_size').val()
        console.log(size);
        WebSync.applyCssToSelection({'font-size':size});
    });
    // Function: void [plugin=TextEdit].disable();
    // Disables the TextEdit plugin.
    this.disable = function(){
		var elem = $("#Text").remove();
		WebSync.updateRibbon();
		$("*").unbind(".TextEdit");
		$("*").undelegate(".TextEdit");
    }
    // Function: void [plugin=TextEdit].selectHandler();
    // Handling function for displaying accurate information about text in ribbon.
    this.selectHandler = function(){
		var style = WebSync.getCss();
		$('#font_size').val(Math.round(parseInt(style.fontSize)*(0.75))+"pt");

		self.text_buttons.forEach(function(elem){
			var button = $('button#'+elem)
			if(document.queryCommandState(elem)){
				button.addClass("active");
			}
			else {
				button.removeClass('active');
			}
		});
		$('#font').val(capitaliseFirstLetter(document.queryCommandValue('fontname').split(",")[0].split("'").join("")));
		clearTimeout(self._selectTimeout);
		self._selectTimeout = null;
	}
    // Sets up the list of fonts
    var fonts = ["Cursive","Monospace","Serif","Sans-serif","Fantasy","Arial","Arial Black","Arial Narrow","Arial Rounded MT Bold","Bookman Old Style","Bradley Hand ITC","Century","Century Gothic","Comic Sans MS","Droid Sans","Courier","Courier New","Georgia","Gentium","Impact","King","Lucida Console","Lalit","Modena","Monotype Corsiva","Papyrus","TeX","Times","Times New Roman","Trebuchet MS","Tahoma","Verdana","Verona",'Helvetica','Segoe'];
    var d = new Detector();
    var font_list = [];
    fonts = fonts.sort(function(a,b){
        if(a&#60;b) return -1;
        if(a&#62b) return 1;
        return 0;
    });
    for (i = 0; i &#60; fonts.length; i++) {
        var result = d.detect(fonts[i]);
        if(result){
            font_list.push("&#60;option&#62"+fonts[i]+"&#60;/option&#62");
        }
    }
    $('#font').html(font_list.join("\n"));
    WebSync.updateRibbon();
});</pre>
            <h3>File: assets/javascripts/fontdetect.js</h3>
            <hr>
                <div class='well'>
                <b>class Detector();</b>
                <br>
                <i>Type: Function, Line: 25</i>
                <br>
                <span>A class used for detecting fonts.</span>
                </div>
                <div class='well'>
                <b>boolean [class=Detector].detect(string font);</b>
                <br>
                <i>Type: Function, Line: 55</i>
                <br>
                <span>Returns whether or not a font exists.</span>
                </div>
            <h4><button class="btn btn-primary" onclick="$('#4').toggle(); false">View Source</a></h4>
            <pre class="script prettyprint linenums" id="4">/**
 * JavaScript code to detect available availability of a
 * particular font in a browser using JavaScript and CSS.
 *
 * Author : Lalit Patel
 * Website: http://www.lalit.org/lab/javascript-css-font-detect/
 * License: Apache Software License 2.0
 *          http://www.apache.org/licenses/LICENSE-2.0
 * Version: 0.15 (21 Sep 2009)
 *          Changed comparision font to default from sans-default-default,
 *          as in FF3.0 font of child element didn't fallback
 *          to parent element if the font is missing.
 * Version: 0.2 (04 Mar 2012)
 *          Comparing font against all the 3 generic font families ie,
 *          'monospace', 'sans-serif' and 'sans'. If it doesn't match all 3
 *          then that font is 100% not available in the system
 * Version: 0.3 (24 Mar 2012)
 *          Replaced sans with serif in the list of baseFonts
 */

/**
 * Usage: d = new Detector();
 *        d.detect('font name');
 */
// Function: class Detector();
// A class used for detecting fonts.
var Detector = function() {
    // a font will be compared against all the three default fonts.
    // and if it doesn't match all 3 then that font is not available.
    var baseFonts = ['monospace', 'sans-serif', 'serif'];

    //we use m or w because these two characters take up the maximum width.
    // And we use a LLi so that the same matching fonts can get separated
    var testString = "mmmmmmmmmmlli";

    //we test using 72px font size, we may use any size. I guess larger the better.
    var testSize = '72px';

    var h = document.getElementsByTagName("body")[0];

    // create a SPAN in the document to get the width of the text we use to test
    var s = document.createElement("span");
    s.style.fontSize = testSize;
    s.innerHTML = testString;
    var defaultWidth = {};
    var defaultHeight = {};
    for (var index in baseFonts) {
        //get the default width for the three base fonts
        s.style.fontFamily = baseFonts[index];
        h.appendChild(s);
        defaultWidth[baseFonts[index]] = s.offsetWidth; //width for the default font
        defaultHeight[baseFonts[index]] = s.offsetHeight; //height for the defualt font
        h.removeChild(s);
    }
    // Function: boolean [class=Detector].detect(string font);
    // Returns whether or not a font exists.
    function detect(font) {
        var detected = false;
        for (var index in baseFonts) {
            s.style.fontFamily = font + ',' + baseFonts[index]; // name of the font along with the base font for fallback.
            h.appendChild(s);
            var matched = (s.offsetWidth != defaultWidth[baseFonts[index]] || s.offsetHeight != defaultHeight[baseFonts[index]]);
            h.removeChild(s);
            detected = detected || matched;
        }
        return detected;
    }

    this.detect = detect;
};</pre>
            <h3>File: assets/javascripts/levenshtein.js</h3>
            <hr>
                <div class='well'>
                <b>int levenshteinenator(string a, string b);</b>
                <br>
                <i>Type: Function, Line: 15</i>
                <br>
                <span>This calculates the Levenshtein distance between strings a and b.</span>
                </div>
                <div class='well'>
                <b>int minimator(int a, int b, int c);</b>
                <br>
                <i>Type: Function, Line: 43</i>
                <br>
                <span>This returns the smallest of the three values passed in.</span>
                </div>
            <h4><button class="btn btn-primary" onclick="$('#5').toggle(); false">View Source</a></h4>
            <pre class="script prettyprint linenums" id="5">/*

Copyright (c) 2006. All Rights reserved.

If you use this script, please email me and let me know, thanks!

Andrew Hedges
andrew (at) hedges (dot) name

If you want to hire me to write JavaScript for you, see my resume.

http://andrew.hedges.name/resume/

*/
// Function: int levenshteinenator(string a, string b);
// This calculates the Levenshtein distance between strings a and b.
levenshteinenator = function(a,b) {
	var cost;
	// get values
	var m = a.length;
	var n = b.length;
	// make sure a.length &#62= b.length to use O(min(n,m)) space, whatever that is
	if (m &#60; n) {
		var c=a;a=b;b=c;
		var o=m;m=n;n=o;
	}
	var r = new Array();
	r[0] = new Array();
	for (var c = 0; c &#60; n+1; c++) {
		r[0][c] = c;
	}
	for (var i = 1; i &#60; m+1; i++) {
		r[i] = new Array();
		r[i][0] = i;
		for (var j = 1; j &#60; n+1; j++) {
			cost = (a.charAt(i-1) == b.charAt(j-1))? 0: 1;
			r[i][j] = minimator(r[i-1][j]+1,r[i][j-1]+1,r[i-1][j-1]+cost);
		}
	}

	return r[m][n];
}
// Function: int minimator(int a, int b, int c);
// This returns the smallest of the three values passed in.
minimator = function(x,y,z) {
	if (x &#60; y && x &#60; z) return x;
	if (y &#60; x && y &#60; z) return y;
	return z;
}</pre>
            <h3>File: assets/javascripts/tables.js</h3>
            <hr>
                <div class='well'>
                <b>void [plugin=edit].disable();</b>
                <br>
                <i>Type: Function, Line: 225</i>
                <br>
                <span>Disables the plugin. This has to be set for possible plugin unloading.</span>
                </div>
            <h4><button class="btn btn-primary" onclick="$('#6').toggle(); false">View Source</a></h4>
            <pre class="script prettyprint linenums" id="6">// WebSync: Tables Plugin
// WebSync uses RequireJS for modules.
// define( [pluginName], [requiredModules], definition);
// pluginName is an optional argument that should only be used if the module is being bundled/loaded without RequireJS. It should match the path it's being required as.
define('/assets/tables.js',['edit','websync'],function(edit,websync){ var self = {};
    // Save all variables and information to the self object.

    // Plugins should use a jQuery namespace for ease of use.
	// Bind Example: $(document).bind("click.Tables", clickHandler);
	// Unbind Example: $("*").unbind(".Tables");
    $(".ribbon").append($('&#60;div id="Table" class="Table container"&#62&#60;button class="btn" title="Delete Table"&#62&#60;i class="icon-trash"&#62&#60;/i&#62 Table&#60;/button&#62&#60;div class="btn-group"&#62&#60;button class="btn" type="button" title="Insert Row Above"&#62&#60;i class="icon-plus"&#62&#60;/i&#62&#60;/button&#62&#60;/span&#62&#60;button class="btn" type="button" title="Delete Row"&#62&#60;i class="icon-trash"&#62&#60;/i&#62 Row&#60;/button&#62&#60;button class="btn" type="button" title="Insert Row Below"&#62&#60;i class="icon-plus"&#62&#60;/i&#62&#60;/button&#62&#60;/div&#62     &#60;div class="btn-group"&#62&#60;button class="btn" type="button" title="Insert Column Left"&#62&#60;i class="icon-plus"&#62&#60;/i&#62&#60;/button&#62&#60;/span&#62&#60;button class="btn" type="button" title="Delete Column"&#62&#60;i class="icon-trash"&#62&#60;/i&#62 Column&#60;/button&#62&#60;button class="btn" type="button" title="Insert Column Right"&#62&#60;i class="icon-plus"&#62&#60;/i&#62&#60;/button&#62&#60;/div&#62&#60;/div&#62'));
    $(".content").append($('&#60;div id="table_cursor" class="Table"&#62&#60;/div&#62&#60;div id="table_selection" class="Table"&#62&#60;/div&#62&#60;div id="table_clip" style="position:absolute; left:-1000px;top:-1000px;"&#62&#60;/div&#62'));
    $("#Insert").append($('&#60;button id="table" title="Table" class="btn Table"&#62&#60;i class="icon-table"&#62&#60;/i&#62&#60;/button&#62'))
    $("#table").bind("click.Tables",function(e){
        console.log(e);
        var new_table = $("&#60;table&#62&#60;tbody&#62&#60;tr&#62&#60;td&#62&#60;/td&#62&#60;td&#62&#60;/td&#62&#60;/tr&#62&#60;tr&#62&#60;td&#62&#60;/td&#62&#60;td&#62&#60;/td&#62&#60;/tr&#62&#60;/tbody&#62&#60;/table&#62")
        WebSync.insertAtCursor(new_table)
    });
	$('.Table [title="Insert Row Above"]').bind("click.Tables",function(e){
		if(self.selected){
			var html = "&#60;tr&#62";
			var size = self.tableSize();
			for(var i=0;i&#60;size[0];i++){
				html+="&#60;td&#62&#60;/td&#62";
			}
			html+="&#60;/tr&#62";
			$(html).insertBefore( self.selectedElem.parentElement);
            self.posCache={};
			self.cursorMove(0,-1);
		}
	});
	$('.Table [title="Insert Row Below"]').bind("click.Tables",function(e){
		if(self.selected){
			var html = "&#60;tr&#62";
			var size = self.tableSize();
			for(var i=0;i&#60;size[0];i++){
				html+="&#60;td&#62&#60;/td&#62";
			}
			html+="&#60;/tr&#62";
			$(html).insertAfter( self.selectedElem.parentElement);
            self.posCache={};
			self.cursorMove(0,1);
		}
	});
	$('.Table [title="Delete Row"]').bind("click.Tables",function(e){
		if(self.selected){
			self.selectedElem.parentElement.remove();
            self.posCache={};
		}
		self.clearSelect();
	});
	$('.Table [title="Insert Column Left"]').bind("click.Tables",function(e){
		if(self.selected){
			var size = self.tableSize();
			var pos = self.selectedPos();
			for(var i=0;i&#60;size[1];i++){
				$("&#60;td&#62&#60;/td&#62").insertBefore(self.selectedElem.parentElement.parentElement.children[i].children[pos[0]]);
			}
			self.cursorMove(-1,0);
            self.posCache={};
		}
	});
	$('.Table [title="Insert Column Right"]').bind("click.Tables",function(e){
		if(self.selected){
			var size = self.tableSize();
			var pos = self.selectedPos();
			for(var i=0;i&#60;size[1];i++){
				$("&#60;td&#62&#60;/td&#62").insertAfter(self.selectedElem.parentElement.parentElement.children[i].children[pos[0]]);
			}
            self.posCache={};
			self.cursorMove(1,0);
		}
	});
	$('.Table [title="Delete Column"]').bind("click.Tables",function(e){
		if(self.selected){
			var size = self.tableSize();
			var pos = self.selectedPos();
			var parentElem = self.selectedElem.parentElement.parentElement
			for(var i=0;i&#60;size[1];i++){
				parentElem.children[i].children[pos[0]].remove();
			}
            self.posCache={};
			self.clearSelect();
		}
	});
	$('.Table [title="Delete Table"]').bind("click.Tables",function(e){
		if(self.selected){
			self.selectedElem.parentElement.parentElement.parentElement.remove();
			self.clearSelect();
		}
	});
    self.observer = function(){
        setTimeout(function(){
			self.cursorUpdate();
		},1);
    };
    $(".content").delegate("table","click.Tables",function(e){
        if(!self.selectedElem || self.selectedElem.contentEditable!="true"){
            $('a:contains("Table")').click();
        }
        e.stopPropagation();
    });
    $(".content").delegate("td","mouseenter.Tables",function(e){
        if(self.selectionActive&&self.primaryTable()===self.primaryTable(this)){
            self.selectionEnd = this;
            self.updateSelectedArea();
        }
    });
    $(".content").delegate("td","mouseleave.Tables",function(e){
    });
    $(".content").delegate("td","mousedown.Tables",function(e){
        console.log(e);
        if(this!=self.selectedElem){
            self.cursorSelect(this);
            self.selectedElem.contentEditable=true;
			self.setEndOfContenteditable(self.selectedElem);
            self.selectedElem.contentEditable="inherit";
        }
        self.selectionActive=true;
        self.selectionEnd = null;
        self.updateSelectedArea();
        e.preventDefault();
    });
    $(".content").delegate("td","mouseup.Tables",function(e){
        self.selectionActive=false;
    });
    self.selectionActive = false;
    $(".content").bind("click.Tables",function(e){
        //console.log(e);
        self.clearSelect();
    });
    $(".content").delegate("td","contextmenu.Tables",function(e){
        if(this!=self.selectedElem){
            self.cursorSelect(this);
        }
        if(self.selectedElem.contentEditable!="true"){
            //e.preventDefault();
            //$(this).contextmenu();
        }
    });
    $(".content").delegate("td","dblclick.Tables",function(e){
		if(self.selectedElem.contentEditable!="true"){
			self.selectedEditable(true);
		}
    });
    $(".content").delegate(".Table.axis#x th", "click.Tables", function(e){
        var pos = self.selectedPos(this);
        var size = self.tableSize();
        self.cursorSelect(self.posToElem(pos[0],0));
        if(!e.shiftKey){
            self.selectionEnd = self.posToElem(pos[0],size[1]-1);
        }
        self.updateSelectedArea();
    });
    $(".content").delegate(".Table.axis#y th", "click.Tables", function(e){
        var pos = self.selectedPos(this);
        var size = self.tableSize();
        self.cursorSelect(self.posToElem(0,pos[1]));
        if(!e.shiftKey){
            self.selectionEnd = self.posToElem(size[0]-1,pos[1]);
        }
        self.updateSelectedArea();
    });
    $(document).bind("paste.Tables",function(e){
        if(self.selected){
            console.log($(e.originalEvent.clipboardData.getData('text/html')));
        }
    });
    $(".content").bind("keydown.Tables",function(e){
        console.log(e);
        if(self.selectedElem){
            if(self.selected){ //&&!e.shiftKey){
                var editting = false;
                if(self.selectedElem.contentEditable){
                    editting=self.selectedElem.contentEditable=="true";
                }
                if(e.keyCode==13&&!e.shiftKey){
                    self.cursorMove(0,1);
                } else if(e.keyCode==9){
                    // Tab key
                    self.selectedEditable(false);
                    self.cursorMove(1-2*e.shiftKey,0);
                    e.preventDefault();
                } else if(e.keyCode==27){
                    // Escape
                    self.selectedEditable(false);
                } else if(e.keyCode==37&&!editting){
                    // Left arrow
                    self.cursorMove(-1,0);
                    e.preventDefault();
                }else if(e.keyCode==39&&!editting){
                    // Right arrow
                    self.cursorMove(1,0);
                    e.preventDefault();
                }else if(e.keyCode==38&&!editting){
                    // Up arrow
                    self.cursorMove(0,-1);
                    e.preventDefault();
                }else if(e.keyCode==40&&!editting){
                    // Down arrow
                    self.cursorMove(0,1);
                    e.preventDefault();
                } else {
                    if((!self.selectedElem.contentEditable||self.selectedElem.contentEditable=="inherit")&&_.indexOf([16,17,18,91,92],e.keyCode)==-1&&!(e.keyCode==67&&e.ctrlKey)){
                        self.selectedEditable(true);

                        $(self.selectedElem).focus();
                        //WebSync.setCaretPosition(self.selectedElem,0);
                    }
                    setTimeout(self.cursorUpdate,1);
                }
            } else {
                if(!self.selectedElem.contentEditable||self.selectedElem.contentEditable=="false"){
                    self.selectedEditable(true);

                    $(self.selectedElem).focus();
                    //WebSync.setCaretPosition(self.selectedElem,0);
                }
            }
        }
    });

    WebSync.updateRibbon();
    $("#ribbon_buttons a:contains('Table')").parent().hide();
	// Function: void [plugin=edit].disable();
    // Disables the plugin. This has to be set for possible plugin unloading.
	self.disable = function(){
		var elem = $(".Table").remove();
		WebSync.updateRibbon();
		$("*").unbind(".Tables");
		$("*").undelegate(".Tables");
	}
	// Helper methods:
	self.cursorSelect = function(td){
        $("#ribbon_buttons a:contains('Table')").parent().fadeIn(200);
		// Cleanup last elem.
		if(self.selectedElem){
			self.selectedEditable(false);
		}
		document.getSelection().removeAllRanges();
		self.selected = true;
		self.selectedElem = td;
        $(self.selectedElem).focus();
		self.selectedEditable(false);
        //self.observer.observe(self.selectedElem,{characterData:true});
        self.selectedElem.addEventListener("DOMSubtreeModified",self.observer);
        if($(".Table.axis").length==0) {
            var size = self.tableSize();
            var nodes = '&#60;table class="Table axis" id="x"&#62&#60;thead&#62&#60;tr&#62';
            for(var i=0;i&#60;size[0];i++){
                var elem = self.posToElem(i,0);
                var bounding = elem.getBoundingClientRect();
                nodes+='&#60;th style="width: '+(bounding.width-1).toFixed(0)+'px"&#62'+self.columnLabel(i)+'&#60;/th&#62';
            }
            nodes+='&#60;/tr&#62&#60;/thead&#62&#60;/table&#62&#60;table class="Table axis" id="y"&#62&#60;thead&#62';
            for(var i=0;i&#60;size[1];i++){
                var elem = self.posToElem(0,i);
                nodes+='&#60;tr&#62&#60;th style="height: '+($(elem).height()+1)+'px"&#62'+(i+1)+'&#60;/th&#62&#60;/tr&#62';
            }
            nodes+='&#60;/thead&#62&#60;/table&#62';
            $(".content").append($(nodes));
            $(".Table.axis").fadeIn(200);
        }
		self.cursorUpdate();
	}
	self.cursorMove = function(dColumn, dRow){
		self.selectedEditable(false);
		var pos = self.selectedPos();
		var column = pos[0];
		var row = pos[1];
		if(self.selectedElem.parentElement.parentElement.children.length&#62row+dRow&&self.selectedElem.parentElement.parentElement.children[0].children.length&#62column+dColumn&&row+dRow&#62=0&&column+dColumn&#62=0){
			var new_td = self.selectedElem.parentElement.parentElement.children[row+dRow].children[column+dColumn];
			self.cursorSelect(new_td);
		}
	}
	self.cursorUpdate = function(){
		var pos = $(self.selectedElem).position();
        pos.top += 2;
        pos.left += 2;
		//$("#table_cursor").animate({left:pos.left,top:pos.top,width:$(self.selectedElem).width()+1,height:$(self.selectedElem).height()},50,'linear').get(0).scrollIntoViewIfNeeded();
        $("#table_cursor").css({left:pos.left,top:pos.top}).height($(self.selectedElem).height()-2).width($(self.selectedElem).width()-1).get(0).scrollIntoViewIfNeeded();
        self.updateSelectedArea();
        var table = $(self.primaryTable());
        var offset = table.offset();
        if(!($(".Table.axis#x").get(0).style.left)){
            $(".Table.axis#x").offset({left:offset.left,top:offset.top-17}).width(table.width()+2);
            $(".Table.axis#y").offset({left:offset.left-39,top:offset.top}).height(table.height());
        }
	}
	self.selectedEditable = function(edit){
		if(!edit){
			self.selectedElem.contentEditable="inherit";
			$("#table_cursor").css({borderStyle: 'solid', outlineStyle: 'solid'});
			$('#ribbon_buttons a:contains("Table")').click();
		}else{
			self.selectedElem.contentEditable=true;
			$("#table_cursor").css({borderStyle: 'dashed', outlineStyle: 'dashed'});
			$('#ribbon_buttons a:contains("Text")').click();
			self.setEndOfContenteditable(self.selectedElem);
		}
	}
    self.clearSelect = function(){
		if(self.selected){
			self.selected = false;
			self.selectedEditable(false);
			$("#table_cursor").offset({left:-10000});
            self.selectedElem.removeEventListener("DOMSubtreeModified",self.observer);
			delete self.selectedElem;
            $("#ribbon_buttons a:contains('Table')").parent().fadeOut(200);
			$('#ribbon_buttons a:contains("Text")').click();
            self.selectedElem=null;
            self.updateSelectedArea();
            $(".Table.axis").fadeOut(200).promise().done(function(){
                $(".Table.axis#x").remove();
                $(".Table.axis#y").remove();
            });
		}
	}
    self.updateSelectedArea = function(){
        $(".Table.axis th").removeClass("active");
        if(self.selectedElem===self.selectionEnd||!self.selectionEnd||!self.selected||self.primaryTable()!=self.primaryTable(self.selectionEnd)){
            $("#table_selection").hide();
            if(self.selected){
                $($(".Table.axis#x").children().children().children()[self.selectedPos()[0]]).addClass("active");
                $($(".Table.axis#y").children().children()[self.selectedPos()[1]]).children().addClass("active");
            }
        }
        else {
            var pos = $(self.selectedElem).position();//offset();
            var endPos = $(self.selectionEnd).position();//offset();
            var baseWidth = $(self.selectionEnd).width();
            var baseHeight = $(self.selectionEnd).height();
            if(pos.left&#62endPos.left){
                var tmp_left = pos.left;
                pos.left = endPos.left;
                endPos.left = tmp_left;
                baseWidth = $(self.selectedElem).width();
            }
            if(pos.top&#62endPos.top){
                var tmp_top = pos.top;
                pos.top = endPos.top;
                endPos.top = tmp_top;
                baseHeight = $(self.selectedElem).height();
            }
            var height = endPos.top+baseHeight -pos.top;
            var width = endPos.left+baseWidth -pos.left;
            $("#table_selection").show().css({left:pos.left,top:pos.top}).height(height).width(width);
            //$("#table_selection").show().animate({top:pos.top,left:pos.left,height:height,width:width},50,'linear');//offset(pos).height(height).width(width);
            // Set hidden selection area contents to mini-table.
            var selection_html = "&#60;table&#62&#60;tbody&#62";
            var tpos_start = self.selectedPos();
            var tpos_end = self.selectedPos(self.selectionEnd);

            var top = tpos_start[1] &#60; tpos_end[1] ? tpos_start[1] : tpos_end[1];
            var bottom = tpos_start[1] &#62 tpos_end[1] ? tpos_start[1] : tpos_end[1];
            var left = tpos_start[0] &#60; tpos_end[0] ? tpos_start[0] : tpos_end[0];
            var right = tpos_start[0] &#62 tpos_end[0] ? tpos_start[0] : tpos_end[0];
            $(".Table.axis#x").children().children().children().slice(left,right+1).addClass("active");
            $(".Table.axis#y").children().children().slice(top,bottom+1).children().addClass("active");
            for(var y=top;y&#60;=bottom;y++){
                selection_html+="&#60;tr&#62";
                for(var x=left;x&#60;=right;x++){
                    selection_html+="&#60;td&#62"+self.selectedElem.parentElement.parentElement.children[y].children[x].innerHTML+"&#60;/td&#62";
                }
                selection_html+="&#60;/tr&#62";
            }
            selection_html+="&#60;/tbody&#62&#60;/table&#62";
            $("#table_clip").html(selection_html);
            // Hidden selection area for copying.
            var range = rangy.createRange();
            range.selectNodeContents($("#table_clip").get(0));
            var sel = rangy.getSelection();
            sel.removeAllRanges();
            sel.addRange(range);
        }
    }
    self.setEndOfContenteditable = function(contentEditableElement)
    {
        var range,selection;
        if(document.createRange)//Firefox, Chrome, Opera, Safari, IE 9+
        {
            range = document.createRange();//Create a range (a range is a like the selection but invisible)
            range.selectNodeContents(contentEditableElement);//Select the entire contents of the element with the range
            range.collapse(false);//collapse the range to the end point. false means collapse to end rather than the start
            selection = window.getSelection();//get the selection object (allows you to change selection)
            selection.removeAllRanges();//remove any selections already made
            selection.addRange(range);//make the range you have just created the visible selection
        }
        else if(document.selection)//IE 8 and lower
        {
            range = document.body.createTextRange();//Create a range (a range is a like the selection but invisible)
            range.moveToElementText(contentEditableElement);//Select the entire contents of the element with the range
            range.collapse(false);//collapse the range to the end point. false means collapse to end rather than the start
            range.select();//Select the range (make it the visible selection
        }
    }
    self.primaryTable = function(elem){
        return (elem||self.selectedElem).parentElement.parentElement.parentElement;
    }
    self.posToElem = function(x, y){
        return self.selectedElem.parentElement.parentElement.children[y].children[x];
    }
    self.posCache = {};
	self.selectedPos = function(targetElem){
        var child = (targetElem||self.selectedElem);
        if(self.posCache[child]){
            return self.posCache[child];
        }
        else {
            var column = 0;
            while( (child = child.previousSibling) != null )
                column++;
            child = (targetElem||self.selectedElem).parentElement
            var row = 0
            while( (child = child.previousSibling) != null )
                row++;
            self.posCache[child]=[column,row];
            return [column,row];
        }
	}
	self.tableSize = function(){
		return [self.selectedElem.parentElement.children.length,self.selectedElem.parentElement.parentElement.children.length]
	}
    // Taken from Stack Overflow
    // http://stackoverflow.com/questions/8603480/how-to-create-a-function-that-converts-a-number-to-a-bijective-hexavigesimal
    var alpha = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
    self.columnLabel = function(a) {
      // First figure out how many digits there are.
      a += 1; // This line is funky
      c = 0;
      var x = 1;
      while (a &#62= x) {
        c++;
        a -= x;
        x *= 26;
      }

      // Now you can do normal base conversion.
      var s = "";
      for (var i = 0; i &#60; c; i++) {
        s = alpha.charAt(a % 26) + s;
        a = Math.floor(a/26);
      }

      return s;
    }

    // Return self so other modules can hook into this one.
    return self;
});</pre>
            <h3>File: views/layout.erb</h3>
            <hr>
                <div class='well'>
                <b>object WebSyncAuth;</b>
                <br>
                <i>Type: Variable, Line: 11</i>
                <br>
                <span>This is an <span class="internal">internal</span> object used for authenticating the websocket connection.</span>
                </div>
                <div class='well'>
                <b>int WebSyncAuth.id;</b>
                <br>
                <i>Type: Variable, Line: 14</i>
                <br>
                <span>This is the websocket connection id. Each connection has a unique id.</span>
                </div>
                <div class='well'>
                <b>int WebSyncAuth.key;</b>
                <br>
                <i>Type: Variable, Line: 17</i>
                <br>
                <span>This is a randomly generated string used as an API key.</span>
                </div>
                <div class='well'>
                <b>object WebSyncData;</b>
                <br>
                <i>Type: Variable, Line: 22</i>
                <br>
                <span>This contains the data for the document. This is automatically synced with the server.</span>
                </div>
            <h4><button class="btn btn-primary" onclick="$('#7').toggle(); false">View Source</a></h4>
            <pre class="script prettyprint linenums" id="7">&#60;!doctype html&#62
&#60;html&#62
	&#60;head&#62
		&#60;link rel="shortcut icon" href="/favicon.ico?v=3" /&#62
        &#60;title&#62WebSync&#60;/title&#62
        &#60;meta name="viewport" content="width=device-width, initial-scale=1.0"&#62
		&#60;%= stylesheet_tag 'default' %&#62
        &#60;%= javascript_tag 'bundle-norm' %&#62
        &#60;% if defined?(@edit)&&@edit %&#62
            &#60;script type="text/javascript"&#62
            // Variable: object WebSyncAuth;
            // This is an internal object used for authenticating the websocket connection.
            WebSyncAuth = {
                // Variable: int WebSyncAuth.id;
                // This is the websocket connection id. Each connection has a unique id.
                id:"&#60;%= @client_id %&#62",
                // Variable: int WebSyncAuth.key;
                // This is a randomly generated string used as an API key.
                key:"&#60;%= @client_key %&#62",
                view_op: "&#60;%= params[:op] %&#62"
            }
            // Variable: object WebSyncData;
            // This contains the data for the document. This is automatically synced with the server.
            WebSyncData = &#60;%= MultiJson.dump(@doc.body) %&#62;

            // Set document title.
            document.title = &#60;%= @doc.name.inspect %&#62 + " - WebSync";
            &#60;/script&#62
            &#60;%= javascript_tag 'bundle-edit' %&#62
        &#60;% end %&#62
	&#60;/head&#62
	&#60;body class="&#60;%= params[:op] %&#62"&#62
        &#60;% if !(defined?(@no_menu)&&@no_menu) %&#62
&#60;div class="menu"&#62
	&#60;div class="navbar navbar-inverse navbar-fixed-top"&#62
		&#60;div class="navbar-inner"&#62
			&#60;div class="container-fluid"&#62
				&#60;a class="brand" href="/" data-toggle="tooltip" title="Produced by Outer Earth Interactive" data-placement="bottom"&#62WebSync&#60;/a&#62
                &#60;ul class="nav"&#62
                    &#60;li class="text"&#62is a document editing tool similar to Google Drive or Microsoft Skydrive. &#60;/li&#62
                &#60;/ul&#62
                &#60;ul id="settings" class="nav pull-right ribbon-opt"&#62
                    &#60;li&#62
                        &#60;a href="/upload" title="Upload"&#62&#60;i class="icon-large icon-cloud-upload"&#62&#60;/i&#62&#60;/a&#62
                    &#60;/li&#62
                    &#60;% if admin? %&#62
                        &#60;li&#62
                            &#60;a href="/admin" title="Admin Control Panel"&#62&#60;i class="icon-cog icon-large"&#62&#60;/i&#62&#60;/a&#62
                        &#60;/li&#62
                    &#60;% end %&#62
                    &#60;li&#62
                        &#60;%= render_login_button %&#62
                    &#60;/li&#62
                &#60;/ul&#62
            &#60;/div&#62
        &#60;/div&#62
    &#60;/div&#62
&#60;/div&#62
        &#60;% end %&#62
		&#60;%= yield %&#62
	&#60;/body&#62
    &#60;% if !defined?(@javascripts).nil? %&#62
        &#60;% @javascripts.each do |script| %&#62
            &#60;script type="text/javascript" src="&#60;%= script %&#62"&#62&#60;/script&#62
        &#60;% end %&#62
    &#60;% end %&#62
    &#60;script type="text/javascript"&#62
        $('[data-toggle="tooltip"]').tooltip();
    &#60;/script&#62
&#60;/html&#62</pre>
        <script type='text/javascript'>
            $("button").click(function(e){
                e.preventDefault();
            });
        </script>
    </body>
</html>
